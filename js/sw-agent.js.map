{"version":3,"file":"js/sw-agent.js","mappings":"SAAA;SACA;;;;;UCDA;UACA;UACA;UACA;UACA,yCAAyC,wCAAwC;UACjF;UACA;UACA,E;;;;;UCPA,wF;;;;;UCAA;UACA;UACA;UACA,uDAAuD,iBAAiB;UACxE;UACA,gDAAgD,aAAa;UAC7D,E;;;;;;;;;;;;;;ACNA;;;;;;;;;;;GAWG;AAmBH,yEAAyE;AACzE,4DAA4D;AAC5D,IAAI,SAAS,GAA2B,IAAI,CAAC;AAE7C,yEAAyE;AACzE;;;;;;;;;GASG;AACI,SAAS,WAAW,CAAC,GAAoB;IAC5C,SAAS,GAAG,GAAG,CAAC;IAEhB,gDAAgD;IAChD,+DAA+D;IAC/D,8CAA8C;IAC9C,IAAI,SAAS,CAAC,aAAa,EAAE,CAAC;QAC1B,SAAS,CAAC,aAAa,CAAC,gBAAgB,CAAC,SAAS,EAAE,eAAe,CAAC,CAAC;QACrE,OAAO,CAAC,GAAG,CAAC,mDAAmD,CAAC,CAAC;IACrE,CAAC;SAAM,CAAC;QACJ,OAAO,CAAC,IAAI,CAAC,6CAA6C,CAAC,CAAC;IAChE,CAAC;AACL,CAAC;AAED,yEAAyE;AACzE;;;;;;;;GAQG;AACI,KAAK,UAAU,qBAAqB,CAAC,GAAW;IACnD,MAAM,YAAY,GAAG,MAAM,SAAS,CAAC,aAAa,EAAE,KAAK,CAAC;IAE1D,IAAI,CAAC,YAAY,EAAE,MAAM,EAAE,CAAC;QACxB,MAAM,IAAI,KAAK,CAAC,2CAA2C,CAAC,CAAC;IACjE,CAAC;IAED,iDAAiD;IACjD,YAAY,CAAC,MAAM,CAAC,WAAW,CAAC;QAC5B,IAAI,EAAE,YAAY;QAClB,GAAG;KACN,CAAC,CAAC;IAEH,OAAO,CAAC,GAAG,CAAC,2CAA2C,GAAG,EAAE,CAAC,CAAC;AAClE,CAAC;AAED,yEAAyE;AACzE;;;;;;;;GAQG;AACH,SAAS,eAAe,CAAC,KAA8B;IACnD,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,GAAG,KAAK,CAAC,IAAI,CAAC;IAE5C,IAAI,CAAC,SAAS,EAAE,CAAC;QACb,OAAO,CAAC,IAAI,CAAC,0DAA0D,CAAC,CAAC;QACzE,OAAO;IACX,CAAC;IAED,QAAQ,IAAI,EAAE,CAAC;QACX,KAAK,eAAe;YAChB,uDAAuD;YACvD,2DAA2D;YAC3D,SAAS,CAAC,iBAAiB,CACvB,gBAAgB,EAChB,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,CAC1B,CAAC;YACF,MAAM;QAEV,KAAK,gBAAgB;YACjB,SAAS,CAAC,iBAAiB,CAAC,iBAAiB,CAAC,CAAC;YAC/C,MAAM;QAEV,KAAK,aAAa;YACd,SAAS,CAAC,iBAAiB,CAAC,cAAc,EAAE,KAAK,IAAI,eAAe,CAAC,CAAC;YACtE,MAAM;QAEV;YACI,OAAO,CAAC,IAAI,CAAC,sCAAsC,IAAI,EAAE,CAAC,CAAC;IACnE,CAAC;AACL,CAAC;AAED,yEAAyE;AACzE;;;GAGG;AACI,SAAS,OAAO;IACnB,IAAI,SAAS,CAAC,aAAa,EAAE,CAAC;QAC1B,SAAS,CAAC,aAAa,CAAC,mBAAmB,CAAC,SAAS,EAAE,eAAe,CAAC,CAAC;IAC5E,CAAC;IACD,SAAS,GAAG,IAAI,CAAC;IACjB,OAAO,CAAC,GAAG,CAAC,qBAAqB,CAAC,CAAC;AACvC,CAAC","sources":["webpack://blazorsw-opus/webpack/bootstrap","webpack://blazorsw-opus/webpack/runtime/define property getters","webpack://blazorsw-opus/webpack/runtime/hasOwnProperty shorthand","webpack://blazorsw-opus/webpack/runtime/make namespace object","webpack://blazorsw-opus/./Scripts/sw-agent/sw-agent.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","/**\r\n * sw-agent.ts — Модуль-посредник между C# (Blazor) и Service Worker\r\n *\r\n * Этот модуль экспортируется как ES-модуль и импортируется в C# через\r\n * IJSRuntime.InvokeAsync<IJSObjectReference>(\"import\", \"./js/sw-agent.js\").\r\n *\r\n * Архитектура взаимодействия:\r\n *   C# (SwAgentInterop) → sw-agent.ts → Service Worker → sw-agent.ts → C#\r\n *\r\n * Модуль хранит ссылку на .NET DotNetObjectReference для обратных вызовов\r\n * (callback) при получении данных от Service Worker.\r\n */\r\n\r\n// ── Типы ──────────────────────────────────────────────────────────────\r\n\r\n/** Структура сообщения, принимаемого от Service Worker */\r\ninterface SwMessage {\r\n    type: \"DATA_RECEIVED\" | \"FETCH_REJECTED\" | \"FETCH_ERROR\";\r\n    payload?: unknown;\r\n    error?: string;\r\n}\r\n\r\n/**\r\n * Типизация .NET DotNetObjectReference.\r\n * Позволяет вызывать [JSInvokable] методы C# из TypeScript.\r\n */\r\ninterface DotNetObjectRef {\r\n    invokeMethodAsync(methodName: string, ...args: unknown[]): Promise<unknown>;\r\n}\r\n\r\n// ── Состояние модуля ──────────────────────────────────────────────────\r\n// Ссылка на .NET-объект; устанавливается при инициализации.\r\nlet dotNetRef: DotNetObjectRef | null = null;\r\n\r\n// ── Инициализация ─────────────────────────────────────────────────────\r\n/**\r\n * Инициализирует модуль-посредник.\r\n * Вызывается из C# при старте приложения.\r\n *\r\n * @param ref — DotNetObjectReference для обратных вызовов в C#.\r\n *\r\n * ВАЖНО: Подписка на navigator.serviceWorker.onmessage устанавливается\r\n * один раз. Повторный вызов initSwAgent обновляет dotNetRef,\r\n * но не создаёт дублирующую подписку.\r\n */\r\nexport function initSwAgent(ref: DotNetObjectRef): void {\r\n    dotNetRef = ref;\r\n\r\n    // Подписываемся на сообщения от Service Worker.\r\n    // Используем addEventListener вместо onmessage для возможности\r\n    // добавления нескольких слушателей в будущем.\r\n    if (navigator.serviceWorker) {\r\n        navigator.serviceWorker.addEventListener(\"message\", handleSwMessage);\r\n        console.log(\"[SwAgent] Initialized. Listening for SW messages.\");\r\n    } else {\r\n        console.warn(\"[SwAgent] Service Worker API not available.\");\r\n    }\r\n}\r\n\r\n// ── Запрос данных ─────────────────────────────────────────────────────\r\n/**\r\n * Отправляет команду Service Worker на выполнение HTTP-запроса.\r\n * Вызывается из C# (SwAgentInterop.RequestDataAsync).\r\n *\r\n * @param url — URL для GET-запроса к серверу.\r\n *\r\n * ВАЖНО: Если SW ещё не зарегистрирован или не активен,\r\n * функция выбрасывает ошибку. C# код должен обработать исключение.\r\n */\r\nexport async function requestDataFromServer(url: string): Promise<void> {\r\n    const registration = await navigator.serviceWorker?.ready;\r\n\r\n    if (!registration?.active) {\r\n        throw new Error(\"[SwAgent] No active Service Worker found.\");\r\n    }\r\n\r\n    // Отправляем команду FETCH_DATA в Service Worker\r\n    registration.active.postMessage({\r\n        type: \"FETCH_DATA\",\r\n        url,\r\n    });\r\n\r\n    console.log(`[SwAgent] Sent FETCH_DATA command. URL: ${url}`);\r\n}\r\n\r\n// ── Обработчик сообщений от SW ────────────────────────────────────────\r\n/**\r\n * Обрабатывает входящие сообщения от Service Worker и перенаправляет\r\n * их в C# через DotNetObjectReference.\r\n *\r\n * Маппинг сообщений на C# методы:\r\n *   DATA_RECEIVED  → OnDataReceived(json)\r\n *   FETCH_REJECTED → OnFetchRejected()\r\n *   FETCH_ERROR    → OnFetchError(message)\r\n */\r\nfunction handleSwMessage(event: MessageEvent<SwMessage>): void {\r\n    const { type, payload, error } = event.data;\r\n\r\n    if (!dotNetRef) {\r\n        console.warn(\"[SwAgent] No .NET reference — cannot forward SW message.\");\r\n        return;\r\n    }\r\n\r\n    switch (type) {\r\n        case \"DATA_RECEIVED\":\r\n            // Сериализуем payload в JSON-строку для передачи в C#.\r\n            // C# десериализует строку обратно в типизированный объект.\r\n            dotNetRef.invokeMethodAsync(\r\n                \"OnDataReceived\",\r\n                JSON.stringify(payload),\r\n            );\r\n            break;\r\n\r\n        case \"FETCH_REJECTED\":\r\n            dotNetRef.invokeMethodAsync(\"OnFetchRejected\");\r\n            break;\r\n\r\n        case \"FETCH_ERROR\":\r\n            dotNetRef.invokeMethodAsync(\"OnFetchError\", error ?? \"Unknown error\");\r\n            break;\r\n\r\n        default:\r\n            console.warn(`[SwAgent] Unknown SW message type: ${type}`);\r\n    }\r\n}\r\n\r\n// ── Очистка ───────────────────────────────────────────────────────────\r\n/**\r\n * Освобождает ресурсы модуля.\r\n * Вызывается из C# при DisposeAsync() SwAgentInterop.\r\n */\r\nexport function dispose(): void {\r\n    if (navigator.serviceWorker) {\r\n        navigator.serviceWorker.removeEventListener(\"message\", handleSwMessage);\r\n    }\r\n    dotNetRef = null;\r\n    console.log(\"[SwAgent] Disposed.\");\r\n}\r\n"],"names":[],"sourceRoot":""}