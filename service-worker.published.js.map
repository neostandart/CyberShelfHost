{"version":3,"file":"service-worker.published.js","mappings":"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","sources":["webpack://blazorsw-opus/webpack/bootstrap","webpack://blazorsw-opus/webpack/runtime/make namespace object","webpack://blazorsw-opus/./Scripts/service-worker/service-worker.published.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","/**\r\n * service-worker.published.ts — Кастомный Service Worker для опубликованного Blazor PWA\r\n *\r\n * Содержит в себе:\r\n *  1. Кастомную логику рассылки (broadcast) и защиты от повторных запросов.\r\n *  2. Стандартную логику Blazor PWA для оффлайн-кэширования ассетов.\r\n */\r\n\r\nexport { }; // Изолируем файл как отдельный модуль для избежания конфликта TS2451\r\n\r\n// ── Типизация Service Worker ──────────────────────────────────────────\r\n\r\ninterface SWClients {\r\n    claim(): Promise<void>;\r\n    matchAll(options?: { type?: string; includeUncontrolled?: boolean }): Promise<SWClient[]>;\r\n}\r\n\r\ninterface SWClient {\r\n    postMessage(message: unknown): void;\r\n    url: string;\r\n}\r\n\r\ninterface ManifestAsset {\r\n    url: string;\r\n    hash: string;\r\n}\r\n\r\ninterface BlazorAssetsManifest {\r\n    version: string;\r\n    assets: ManifestAsset[];\r\n}\r\n\r\ninterface SWGlobalScope {\r\n    skipWaiting(): Promise<void>;\r\n    clients: SWClients;\r\n    addEventListener(type: string, listener: (event: any) => void): void;\r\n    importScripts(...urls: string[]): void;\r\n    assetsManifest: BlazorAssetsManifest;\r\n    origin: string;\r\n}\r\n\r\nconst sw: SWGlobalScope = self as unknown as SWGlobalScope;\r\n\r\n// Импорт манифеста, который генерируется при публикации\r\nsw.importScripts('./service-worker-assets.js');\r\n\r\n// ── Настройки кэширования Blazor PWA ──────────────────────────────────\r\nconst cacheNamePrefix = 'offline-cache-';\r\nconst cacheName = `${cacheNamePrefix}${sw.assetsManifest.version}`;\r\nconst offlineAssetsInclude = [/\\.dll$/, /\\.pdb$/, /\\.wasm/, /\\.html/, /\\.js$/, /\\.json$/, /\\.css$/, /\\.woff$/, /\\.png$/, /\\.jpe?g$/, /\\.gif$/, /\\.ico$/, /\\.blat$/, /\\.dat$/];\r\nconst offlineAssetsExclude = [/^service-worker\\.js$/, /^service-worker\\.published\\.js$/];\r\n\r\n//const base = \"/\";\r\nconst base = \"/CyberShelfHost/\";\r\nconst baseUrl = new URL(base, sw.origin);\r\nconst manifestUrlList = sw.assetsManifest.assets.map(asset => new URL(asset.url, baseUrl).href);\r\n\r\n// ── Типы сообщений ────────────────────────────────────────────────────\r\ninterface SwIncomingMessage {\r\n    type: \"FETCH_DATA\";\r\n    url: string;\r\n}\r\n\r\ninterface SwOutgoingMessage {\r\n    type: \"DATA_RECEIVED\" | \"FETCH_REJECTED\" | \"FETCH_ERROR\";\r\n    payload?: unknown;\r\n    error?: string;\r\n}\r\n\r\nlet isBusy = false;\r\n\r\n// ── Lifecycle: install ────────────────────────────────────────────────\r\nsw.addEventListener('install', (event: any) => {\r\n    console.info('[SW] Installing published version...');\r\n    event.waitUntil(\r\n        (async () => {\r\n            // Кэширование ассетов (из Blazor PWA)\r\n            const assetsRequests = sw.assetsManifest.assets\r\n                .filter(asset => offlineAssetsInclude.some(pattern => pattern.test(asset.url)))\r\n                .filter(asset => !offlineAssetsExclude.some(pattern => pattern.test(asset.url)))\r\n                .map(asset => new Request(asset.url, { integrity: asset.hash, cache: 'no-cache' }));\r\n\r\n            const cache = await caches.open(cacheName);\r\n            await cache.addAll(assetsRequests);\r\n\r\n            // Пропускаем ожидание\r\n            await sw.skipWaiting();\r\n        })()\r\n    );\r\n});\r\n\r\n// ── Lifecycle: activate ───────────────────────────────────────────────\r\nsw.addEventListener('activate', (event: any) => {\r\n    console.info('[SW] Activated published version. Claiming clients...');\r\n    event.waitUntil(\r\n        (async () => {\r\n            // Удаление старых кэшей (из Blazor PWA)\r\n            const cacheKeys = await caches.keys();\r\n            await Promise.all(cacheKeys\r\n                .filter(key => key.startsWith(cacheNamePrefix) && key !== cacheName)\r\n                .map(key => caches.delete(key)));\r\n\r\n            // Перехват клиентов\r\n            await sw.clients.claim();\r\n        })()\r\n    );\r\n});\r\n\r\n// ── Message handler ───────────────────────────────────────────────────\r\nsw.addEventListener(\"message\", (event: { data: SwIncomingMessage; waitUntil?: (p: Promise<void>) => void }) => {\r\n    const data = event.data;\r\n\r\n    if (data.type === \"FETCH_DATA\") {\r\n        if (isBusy) {\r\n            console.warn(\"[SW] Busy — rejecting FETCH_DATA request.\");\r\n            broadcastMessage({ type: \"FETCH_REJECTED\" });\r\n            return;\r\n        }\r\n\r\n        const promise = fetchDataFromServer(data.url);\r\n        if (event.waitUntil) {\r\n            event.waitUntil(promise);\r\n        }\r\n    }\r\n});\r\n\r\n// ── Fetch logic (Custom) ──────────────────────────────────────────────\r\nasync function fetchDataFromServer(url: string): Promise<void> {\r\n    isBusy = true;\r\n    console.log(`[SW] Fetching data from: ${url}`);\r\n\r\n    try {\r\n        const response = await fetch(url, {\r\n            method: \"GET\",\r\n            headers: { \"Accept\": \"application/json\" },\r\n            cache: \"no-cache\",\r\n        });\r\n\r\n        if (!response.ok) {\r\n            throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n        }\r\n\r\n        const payload: unknown = await response.json();\r\n        await broadcastMessage({ type: \"DATA_RECEIVED\", payload });\r\n        console.log(\"[SW] Data fetched and broadcasted successfully.\");\r\n    } catch (error) {\r\n        const message = error instanceof Error ? error.message : String(error);\r\n        console.error(\"[SW] Fetch error:\", message);\r\n        await broadcastMessage({ type: \"FETCH_ERROR\", error: message });\r\n    } finally {\r\n        isBusy = false;\r\n    }\r\n}\r\n\r\n// ── Broadcast helper ──────────────────────────────────────────────────\r\nasync function broadcastMessage(message: SwOutgoingMessage): Promise<void> {\r\n    const allClients = await sw.clients.matchAll({\r\n        type: \"window\",\r\n        includeUncontrolled: true,\r\n    });\r\n\r\n    for (const client of allClients) {\r\n        client.postMessage(message);\r\n    }\r\n}\r\n\r\n// ── Fetch event (Blazor PWA Offline Support) ──────────────────────────\r\nsw.addEventListener('fetch', (event: any) => {\r\n    event.respondWith(\r\n        (async () => {\r\n            let cachedResponse = null;\r\n            if (event.request.method === 'GET') {\r\n                // Если запрос к API (FETCH_DATA или обычный) - не обслуживаем index.html\r\n                // Мы применяем логику обслуживания index.html только к навигационным запросам браузера\r\n                const shouldServeIndexHtml = event.request.mode === 'navigate'\r\n                    && !manifestUrlList.some(url => url === event.request.url);\r\n\r\n                const request = shouldServeIndexHtml ? 'index.html' : event.request;\r\n                const cache = await caches.open(cacheName);\r\n                cachedResponse = await cache.match(request);\r\n            }\r\n\r\n            return cachedResponse || fetch(event.request);\r\n        })()\r\n    );\r\n});\r\n"],"names":[],"sourceRoot":""}