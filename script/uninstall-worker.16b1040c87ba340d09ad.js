function e(e){let t="";if(e instanceof Event)if(e.target instanceof IDBOpenDBRequest){const t=e.target;t.error&&(e=t.error)}else e.message&&(t=e.message);else if(e instanceof Error){const o=e;t=o.name,t.endsWith(".")||(t+="."),o.message&&(t+=" "+o.message)}else if(e instanceof Response){const s=e;t=o(`Response: ok=${s.ok}; status=${s.status}; statusText=${s.statusText}; type=${s.type}; url=${s.url}.`)}else"string"==typeof e?t=e:(e&&e.name&&(t=o(e.name)),e&&e.status&&(t=o(`status=${e.status}`)),e&&e.statusText&&(t=o(`statusText=${e.statusText}`)));return t;function o(e){return t.length>0?t+=` | ${e}`:e}}new Map([["css","text/css"],["js","application/x-javascript"],["json","application/json"],["docx","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],["ico","image/x-icon"],["jpeg","image/jpeg"],["jpg","image/jpeg"],["png","image/png"],["svg","image/svg+xml"],["bmp","image/bmp"],["mp3","audio/mpeg"],["mpeg","video/mpeg"],["mpg","video/mpeg"],["wma","audio/x-ms-wma"],["wav","audio/wav"]]);let t=0,o=null;function s(e){return new Promise((t,o)=>{e.onsuccess=o=>{o.target instanceof IDBRequest?(e=o.target,t(e.result)):t(void 0)},e.onerror=e=>{o(e)}})}var n,a,i,r;!function(e){e[e.Local=0]="Local",e[e.Storage=1]="Storage",e[e.Service=2]="Service",e[e.Link=3]="Link"}(n||(n={})),function(e){e[e.None=0]="None",e[e.CssUrl=1]="CssUrl"}(a||(a={})),function(e){e[e.Classic=0]="Classic",e[e.Regular=1]="Regular",e[e.VMBook=2]="VMBook"}(i||(i={})),function(e){e[e.Undef=0]="Undef",e[e.Start=1]="Start",e[e.Download=2]="Download",e[e.Parsing=3]="Parsing",e[e.Integration=4]="Integration",e[e.Finish=5]="Finish",e[e.Error=6]="Error"}(r||(r={}));class c{id;origId;name;version;isPopup;packtype;sourceType;suiteid;filename;filesize;modified;isBroken;constructor(e){this.id=e.id,this.origId=e.origId,this.name=e.name,this.version=e.version,this.isPopup=e.isPopup,this.packtype=e.packtype||i.Classic,this.sourceType=e.sourceType,this.suiteid=e.suiteid,this.filename=e.fileinfo.fullname,this.filesize=e.fileinfo.size,this.modified=e.fileinfo.modified,this.isBroken=e.isBroken}}let l,d=null;async function u(){d=await(t++,new Promise((t,s)=>{if(o)t(o);else{let n=indexedDB.open("AppDB",1);n.onerror=t=>{let o=e(t);s(new Error("AppDB Error: "+o))},n.onblocked=e=>{s(new Error("AppDB Failure: The application database is blocked"))},n.onsuccess=e=>{let s=e.target;o=s.result,t(o)},n.onupgradeneeded=e=>{!function(e){let t=e.target.result;e.oldVersion<3&&(function(){const e=t.objectStoreNames;for(let o=0;o<e.length;o++)t.deleteObjectStore(e[o])}(),function(){t.createObjectStore("_system"),t.createObjectStore("shared"),t.createObjectStore("users"),t.createObjectStore("shelves"),t.createObjectStore("stuffs"),t.createObjectStore("results"),t.createObjectStore("suites"),t.createObjectStore("packs"),t.createObjectStore("packcont"),t.createObjectStore("packext");const e=t.createObjectStore("wincache");e.createIndex("user_idx","userId"),e.createIndex("pack_idx","packId"),t.createObjectStore("libs"),t.createObjectStore("libfiles")}())}(e)}}}))}self.addEventListener("message",async n=>{const a=n.data;try{switch(l=a.params,!0){case"string"==typeof a.bookId:await u();const t=await async function(t){function o(e){return!!l.find(t=>t.dependencies.indexOf(e)>=0)}const n=await async function(e,t,o){let n=d.transaction(t,"readonly").objectStore(t);return await s(n.get(o))}(0,"packs",t);if(!n)throw new Error(`The package for uninstall (${t}) was not found!`);const a=new c(n),i=n.dependencies,r=new Set,l=await async function(e,t){let o;try{let n=e.transaction(t,"readonly").objectStore(t);o=await s(n.getAll())}finally{return o||[]}}(d,"packs"),u=l.findIndex(e=>e.id===t);l.splice(u,1);for(const e of i)o(e)||r.add(e);const p=await(f=d,g="wincache",m=t,new Promise(async(e,t)=>{const o=f.transaction(g).objectStore(g).index("pack_idx"),s=[],n=o.openKeyCursor(IDBKeyRange.only(m));n.onsuccess=function(){var t=n.result;t?(s.push(t.primaryKey),t.continue()):e(s)},n.onerror=function(e){t(e)}}));var f,g,m;let b=null;try{b=d.transaction(["libs","libfiles","packs","packext","packcont","wincache"],"readwrite"),b.onerror=function(t){b=null;let o=e(t);console.error(`uninstall-worker.ts/doUninstall: An transaction error occurred while deinstallation book: ${o}`)},b.oncomplete=function(e){b=null};let o=b.objectStore("libs"),n=b.objectStore("libfiles");for(const e of r)await s(o.delete(e)),await s(n.delete(e));let i=b.objectStore("packs");await s(i.delete(t));let c=b.objectStore("packext");await s(c.delete(t));let l=b.objectStore("packcont");await s(l.delete(t));const u=b.objectStore("wincache");for(const e of p)await s(u.delete(e));return a}catch(e){throw e}}(a.bookId);self.postMessage({msgtype:"done",bookCase:t});break;case void 0!==a.libBrief:await u(),await async function(e){const t=d.transaction(["libs","libfiles","_system"],"readwrite"),o=t.objectStore("_system"),n=await s(o.get("addons"))||{},a=Object.keys(n).find(t=>n[t].token===e.key);a&&(delete n[a],await s(o.put(n,"addons")));let i=t.objectStore("libs"),r=t.objectStore("libfiles");return await s(i.delete(e.key)),await s(r.delete(e.key)),e}(a.libBrief),self.postMessage({msgtype:"done",libBrief:a.libBrief})}}catch(t){self.postMessage({msgtype:"error",bookName:a.BookName,message:e(t)})}finally{d&&(t--,t<1&&(t=0,o&&(o.close(),o=null))),d=null}});