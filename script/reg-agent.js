var e={309:(e,t,a)=>{a.d(t,{e:()=>n,t:()=>r});const r={CONTINUE:100,SWITCHING_PROTOCOLS:101,PROCESSING:102,EARLY_HINTS:103,OK:200,CREATED:201,ACCEPTED:202,NON_AUTHORITATIVE_INFORMATION:203,NO_CONTENT:204,RESET_CONTENT:205,PARTIAL_CONTENT:206,MULTIPLE_CHOICES:300,MOVED_PERMANENTLY:301,FOUND:302,SEE_OTHER:303,NOT_MODIFIED:304,TEMPORARY_REDIRECT:307,PERMANENT_REDIRECT:308,BAD_REQUEST:400,UNAUTHORIZED:401,PAYMENT_REQUIRED:402,FORBIDDEN:403,NOT_FOUND:404,METHOD_NOT_ALLOWED:405,NOT_ACCEPTABLE:406,CONFLICT:409,GONE:410,TOO_MANY_REQUESTS:429,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,GATEWAY_TIMEOUT:504};var n;!function(e){e[e.RegVerifying=0]="RegVerifying",e[e.RegRegistering=1]="RegRegistering",e[e.RegWaiting=2]="RegWaiting",e[e.RegUnregistering=3]="RegUnregistering",e[e.RegVerified=4]="RegVerified",e[e.RegRegistered=5]="RegRegistered",e[e.RegUnregistered=6]="RegUnregistered",e[e.RegDeclined=7]="RegDeclined",e[e.RegDiscarded=8]="RegDiscarded",e[e.HttpFailure=9]="HttpFailure",e[e.HttpError=10]="HttpError"}(n||(n={}))},643:(e,t,a)=>{new Map([["css","text/css"],["js","application/x-javascript"],["json","application/json"],["docx","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],["ico","image/x-icon"],["jpeg","image/jpeg"],["jpg","image/jpeg"],["png","image/png"],["svg","image/svg+xml"],["bmp","image/bmp"],["mp3","audio/mpeg"],["mpeg","video/mpeg"],["mpg","video/mpeg"],["wma","audio/x-ms-wma"],["wav","audio/wav"]]);let r=0,n=null;function s(){return r++,new Promise((e,t)=>{if(n)e(n);else{let a=indexedDB.open("AppDB",1);a.onerror=e=>{let a=function(e){let t="";if(e instanceof Event)if(e.target instanceof IDBOpenDBRequest){const t=e.target;t.error&&(e=t.error)}else e.message&&(t=e.message);else if(e instanceof Error){const a=e;t=a.name,t.endsWith(".")||(t+="."),a.message&&(t+=" "+a.message)}else if(e instanceof Response){const r=e;t=a(`Response: ok=${r.ok}; status=${r.status}; statusText=${r.statusText}; type=${r.type}; url=${r.url}.`)}else"string"==typeof e?t=e:(e&&e.name&&(t=a(e.name)),e&&e.status&&(t=a(`status=${e.status}`)),e&&e.statusText&&(t=a(`statusText=${e.statusText}`)));return t;function a(e){return t.length>0?t+=` | ${e}`:e}}(e);t(new Error("AppDB Error: "+a))},a.onblocked=e=>{t(new Error("AppDB Failure: The application database is blocked"))},a.onsuccess=t=>{let a=t.target;n=a.result,e(n)},a.onupgradeneeded=e=>{!function(e){let t=e.target.result;e.oldVersion<3&&(function(){const e=t.objectStoreNames;for(let a=0;a<e.length;a++)t.deleteObjectStore(e[a])}(),function(){t.createObjectStore("_system"),t.createObjectStore("shared"),t.createObjectStore("users"),t.createObjectStore("shelves"),t.createObjectStore("stuffs"),t.createObjectStore("results"),t.createObjectStore("suites"),t.createObjectStore("packs"),t.createObjectStore("packcont"),t.createObjectStore("packext");const e=t.createObjectStore("wincache");e.createIndex("user_idx","userId"),e.createIndex("pack_idx","packId"),t.createObjectStore("libs"),t.createObjectStore("libfiles")}())}(e)}}})}function i(){r--,r<1&&(r=0,n&&(n.close(),n=null))}function o(e){return new Promise((t,a)=>{e.onsuccess=a=>{a.target instanceof IDBRequest?(e=a.target,t(e.result)):t(void 0)},e.onerror=e=>{a(e)}})}var c=a(309);const l=self;var p=!1;function g(e){return e instanceof Error?e.message:"string"==typeof e?e:"Unknown error"}function u(e){return new Promise(t=>setTimeout(t,e))}async function d(e){const t=await l.clients.matchAll();for(const a of t)a.postMessage(e)}class y extends Error{attempts;constructor(e){super(`Опрос был отменен после ${e} попыток`),this.attempts=e,this.name="PollingCancelledError"}}class R{_url;_options;_requestOptions;_attempts=0;_isCancelled=!1;constructor(e,t={},a){this._url=e,this._options={interval:5e3,...t},this._requestOptions={headers:{"Content-Type":"application/json",Accept:"application/json",...a.headers},...a}}async makeRequest(){const e=await fetch(this._url,this._requestOptions);if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);return await e.json()??null}cancel(){this._isCancelled=!0}getAttemptCount(){return this._attempts}async poll(){for(;!this._isCancelled;){this._attempts++,this._options.onAttempt&&this._options.onAttempt(this._attempts);try{var e=await this.makeRequest();if(this._options.validateResponse&&(null===e||this._options.validateResponse(e)||(e=null)),null!==e)return console.log(`The data was successfully received on the attempt ${this._attempts}`),e}catch(e){const t=e instanceof Error?e:new Error(String(e));console.error(`Error on attempt ${this._attempts}:`,t.message),this._options.onError&&this._options.onError(t)}if(this._isCancelled)break;await u(this._options.interval)}throw new y(this._attempts)}}async function f(){return await async function(e,t){let a;try{let r=(await s()).transaction(e,"readonly").objectStore(e);a=await o(r.get(t))}finally{return i(),a}}("_system","credential")}async function h(e){return async function(e,t,a){try{let r=(await s()).transaction(e,"readwrite").objectStore(e);await o(r.put(t,a))}finally{i()}}("_system",e,"credential")}async function E(){return async function(e){try{(await s()).transaction(e,"readwrite").objectStore(e).delete("credential")}finally{i()}}("_system")}async function m(e,t){const a=new R(e,{interval:7e3,validateResponse:e=>!e.email&&!e.cryptoKeyValue||!!e.email&&!!e.cryptoKeyValue},{method:"GET",mode:"cors",headers:{Authorization:t.apiKey,Accept:"application/json","Content-Type":"application/json"}});let r;const n=await a.poll();if("string"==typeof n.cryptoKeyValue){if(t.anchor!==n.email)throw await E(),new Error(`Inconsistent user's details: "${t.anchor}" & "${n.email}" is not equal!`);t.cryptoKey=n.cryptoKeyValue,await h(t),r={type:c.e.RegRegistered,credential:t,unregAgentInfo:n.deletedApiKeyInfo}}else await E(),r={type:c.e.RegDeclined,message:null};return r}l.addEventListener("install",e=>{l.skipWaiting()}),l.addEventListener("activate",e=>{e.waitUntil(l.clients.claim())}),l.addEventListener("fetch",e=>{}),l.addEventListener("message",async e=>{if(!p){const t=e.data;switch(t.type){case"VERIFICATION":p=!0,d({type:c.e.RegVerifying}),await async function(e){var t;try{const a=await f();switch(!0){case"object"==typeof a&&!!a?.cryptoKey:const r={method:"GET",mode:"cors",headers:{Authorization:a.apiKey}},n=await fetch(e.verificationRequest,r);if(n.ok)t={type:c.e.RegVerified,credential:a};else switch(n.status){case c.t.UNAUTHORIZED:case c.t.FORBIDDEN:t={type:c.e.RegDiscarded,message:null},await E();break;default:t={type:c.e.HttpError,credential:await f(),message:`Server error. Response status: ${n.status}.`}}break;case"object"==typeof a:d({type:c.e.RegWaiting,anchor:a.anchor}),t=await m(e.cryptoKeyRequest,a);break;default:a&&await E(),t={type:c.e.RegVerified,credential:null}}}catch(e){t={type:c.e.HttpError,credential:await f(),message:g(e)}}d(t)}(t),p=!1;break;case"REGISTRATION":p=!0,d({type:c.e.RegRegistering,anchor:t.anchor}),await async function(e){const t={email:e.anchor,apiKeyValue:void 0};try{const a=await fetch(e.apiKeyRequest,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});switch(a.status){case c.t.OK:{const t=await a.json();if(!function(e){if("object"!=typeof e||null===e)return!1;const t=Object.hasOwn(e,"email")&&"string"==typeof e.email,a=Object.hasOwn(e,"apiKeyValue")&&"string"==typeof e.apiKeyValue;return t&&a}(t))throw new Error(`Inconsistent response data! (request: ${e.apiKeyRequest})`);let r={anchor:t.email,apiKey:t.apiKeyValue,cryptoKey:void 0};await h(r),d({type:c.e.RegWaiting,anchor:r.anchor}),d(await m(e.cryptoKeyRequest,r))}break;case c.t.FORBIDDEN:d({type:c.e.HttpFailure,status:a.status,credential:await f()});break;default:throw new Error(`HTTP error! status: ${a.status}`)}}catch(e){d({type:c.e.HttpError,credential:await f(),message:g(e)})}}(t),p=!1;break;case"UNREGISTRATION":p=!0,d({type:c.e.RegUnregistering,anchor:t.anchor}),await async function(e){try{const t=await fetch(e.unregRequest,{method:"DELETE",headers:{Authorization:e.apiKey}});switch(t.status){case c.t.OK:await E(),d({type:c.e.RegUnregistered,anchor:e.anchor});break;case c.t.UNAUTHORIZED:case c.t.FORBIDDEN:await E(),d({type:c.e.HttpFailure,status:t.status,credential:await f()});break;default:throw new Error(`HTTP error! status: ${t.status}`)}}catch(e){d({type:c.e.HttpError,credential:await f(),message:g(e)})}}(t),p=!1}}})}},t={};function a(r){var n=t[r];if(void 0!==n)return n.exports;var s=t[r]={exports:{}};return e[r](s,s.exports,a),s.exports}a.d=(e,t)=>{for(var r in t)a.o(t,r)&&!a.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var r={};a.d(r,{Dh:()=>l,MX:()=>i,ht:()=>c,kz:()=>o}),a(643);var n=a(309);let s;function i(e,t){"serviceWorker"in navigator&&navigator.serviceWorker.controller?navigator.serviceWorker.controller.postMessage({type:"VERIFICATION",verificationRequest:e,cryptoKeyRequest:t}):console.warn("Service Worker not active, cannot start verification.")}function o(e,t,a){"serviceWorker"in navigator&&navigator.serviceWorker.controller?navigator.serviceWorker.controller.postMessage({type:"REGISTRATION",anchor:e,apiKeyRequest:t,cryptoKeyRequest:a}):console.warn("Service Worker not active, cannot start checking.")}function c(e,t,a){"serviceWorker"in navigator&&navigator.serviceWorker.controller?navigator.serviceWorker.controller.postMessage({type:"UNREGISTRATION",apiKey:e,anchor:t,unregRequest:a}):console.warn("Service Worker not active, cannot start checking.")}async function l(e){s=e}"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",async e=>{if("type"in e.data)switch(e.data.type){case n.e.RegVerifying:s.invokeMethodAsync("InformVerifying");break;case n.e.RegRegistering:const t=e.data;s.invokeMethodAsync("InformRegistering",t.anchor);break;case n.e.RegWaiting:const a=e.data;s.invokeMethodAsync("InformWaiting",a.anchor);break;case n.e.RegUnregistering:s.invokeMethodAsync("InformUnregistering");break;case n.e.RegVerified:const r=e.data;s.invokeMethodAsync("InformVerified",r.credential);break;case n.e.RegRegistered:const i=e.data;s.invokeMethodAsync("InformRegistered",i.credential,i.unregAgentInfo);break;case n.e.RegUnregistered:const o=e.data;s.invokeMethodAsync("InformUnregistered",o.anchor);break;case n.e.RegDeclined:const c=e.data;s.invokeMethodAsync("InformDeclined",c.message);break;case n.e.RegDiscarded:const l=e.data;s.invokeMethodAsync("InformDiscarded",l.message);break;case n.e.HttpFailure:const p=e.data;s.invokeMethodAsync("HandleHttpFailure",p.status,p.credential);break;case n.e.HttpError:const g=e.data;s.invokeMethodAsync("HandleHttpError",g.credential,g.message)}});const p=r.Dh,g=r.kz,u=r.ht,d=r.MX;export{p as initializeAsync,g as register,u as unregister,d as verify};