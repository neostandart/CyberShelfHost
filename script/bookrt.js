var e={m:{},d:(t,n)=>{for(var s in n)e.o(n,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:n[s]})},u:e=>303===e?"install-worker.eb48542d726b9757f011.js":54===e?"uninstall-worker.069d0486e0baaa0a1d58.js":void 0,o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}};(()=>{var t;if("string"==typeof import.meta.url&&(t=import.meta.url),!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),e.p=t})(),e.b=new URL("./",import.meta.url);var t={};e.r(t),e.d(t,{delObject:()=>R,delUser:()=>U,get:()=>L,getAll:()=>A,getAllFrom:()=>S,getByKeys:()=>P,getFrom:()=>x,getKeysByIndex:()=>T,getKeysByIndexFrom:()=>O,getWinCache:()=>D,initializeAsync:()=>C,processStoreRequest:()=>j,put:()=>I,releaseDB:()=>v,setWinCache:()=>M,useDB:()=>_});var n={};e.r(n),e.d(n,{decrypt:()=>Z,discardCryptoKey:()=>Q,getCryptoKey:()=>Y,hasCryptoKey:()=>X,importCryptoKey:()=>G});var s={};e.r(s),e.d(s,{clear:()=>ae,hasPackage:()=>se,remove:()=>ie,render:()=>ne});var i={};e.r(i),e.d(i,{abort:()=>we,attachLibraryInput:()=>ye,attachPackageInput:()=>me,initialize:()=>je,invokeBookInstall:()=>be,invokeLibraryInstall:()=>_e,invokeLibraryUninstall:()=>ve,setup:()=>ge,uninstallBook:()=>ke});var a={};function r(e){return new Promise((t,n)=>{fetch(e).then(e=>{!0===e.ok?t(e.json()):n(c(e))})})}e.r(a),e.d(a,{fetchBookAnnotation:()=>Ue,fetchBookCases:()=>Ie,fetchBookCover:()=>De,fetchBookInfo:()=>Oe,fetchBookInfoList:()=>Te,fetchLibraryList:()=>Ce,findPackageByFile:()=>Be,getBookOverviewPrompt:()=>Me,hasBookAnnotation:()=>Re,hasPackageRefs:()=>Ee,initializeAsync:()=>$e});const o=new Map([["css","text/css"],["js","application/x-javascript"],["json","application/json"],["docx","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],["ico","image/x-icon"],["jpeg","image/jpeg"],["jpg","image/jpeg"],["png","image/png"],["svg","image/svg+xml"],["bmp","image/bmp"],["mp3","audio/mpeg"],["mpeg","video/mpeg"],["mpg","video/mpeg"],["wma","audio/x-ms-wma"],["wav","audio/wav"]]);function c(e){let t="";if(e instanceof Event)if(e.target instanceof IDBOpenDBRequest){const t=e.target;t.error&&(e=t.error)}else e.message&&(t=e.message);else if(e instanceof Error){const n=e;t=n.name,t.endsWith(".")||(t+="."),n.message&&(t+=" "+n.message)}else if(e instanceof Response){const s=e;t=n(`Response: ok=${s.ok}; status=${s.status}; statusText=${s.statusText}; type=${s.type}; url=${s.url}.`)}else"string"==typeof e?t=e:(e&&e.name&&(t=n(e.name)),e&&e.status&&(t=n(`status=${e.status}`)),e&&e.statusText&&(t=n(`statusText=${e.statusText}`)));return t;function n(e){return t.length>0?t+=` | ${e}`:e}}function l(e,t){const n=(t=t||{}).delimiter||".",s=t.maxDepth,i=t.transformKey||function(e){return e},a={};return function e(r,o,c){c=c||1,Object.keys(r).forEach(function(l){const u=r[l],d=t.safe&&Array.isArray(u),f=Object.prototype.toString.call(u),h=(p=u)&&p.constructor&&"function"==typeof p.constructor.isBuffer&&p.constructor.isBuffer(p);var p;const m="[object Object]"===f||"[object Array]"===f,y=o?o+n+i(l):i(l);if(!d&&!h&&m&&Object.keys(u).length&&(!t.maxDepth||c<s))return e(u,y,c+1);a[y]=u})}(e,void 0,void 0),a}const u="AppDB";let d,f,h,p,m,y,b,g=1,w=0,k=null;function _(){return w++,new Promise((e,t)=>{if(k)e(k);else{let n=indexedDB.open(u,g);n.onerror=e=>{let n=c(e);t(new Error("AppDB Error: "+n))},n.onblocked=e=>{t(new Error("AppDB Failure: The application database is blocked"))},n.onsuccess=t=>{let n=t.target;k=n.result,e(k)},n.onupgradeneeded=e=>{!function(e){let t=e.target.result;e.oldVersion<3&&(function(){const e=t.objectStoreNames;for(let n=0;n<e.length;n++)t.deleteObjectStore(e[n])}(),function(){t.createObjectStore("_system"),t.createObjectStore("shared"),t.createObjectStore("users"),t.createObjectStore("shelves"),t.createObjectStore("stuffs"),t.createObjectStore("results"),t.createObjectStore("suites"),t.createObjectStore("packs"),t.createObjectStore("packcont"),t.createObjectStore("packext");const e=t.createObjectStore("wincache");e.createIndex("user_idx","userId"),e.createIndex("pack_idx","packId"),t.createObjectStore("libs"),t.createObjectStore("libfiles")}())}(e)}}})}function v(){w--,w<1&&(w=0,k&&(k.close(),k=null))}function j(e){return new Promise((t,n)=>{e.onsuccess=n=>{n.target instanceof IDBRequest?(e=n.target,t(e.result)):t(void 0)},e.onerror=e=>{n(e)}})}async function L(e,t){let n;try{let s=(await _()).transaction(e,"readonly").objectStore(e);n=await j(s.get(t))}finally{return v(),n}}async function x(e,t,n){let s=e.transaction(t,"readonly").objectStore(t);return await j(s.get(n))}async function P(e,t){return new Promise(async(n,s)=>{const i=[];let a=(await _()).transaction(e).objectStore(e).openCursor();a.onsuccess=e=>{const s=e.target.result;s?(t.findIndex(e=>s.key==e)>=0&&i.push(s.value),s.continue()):(v(),n(i))},a.onerror=e=>{v(),s(c(e))}})}async function A(e){let t;try{let n=(await _()).transaction(e,"readonly").objectStore(e);t=await j(n.getAll())}finally{return v(),t||[]}}async function S(e,t){let n;try{let s=e.transaction(t,"readonly").objectStore(t);n=await j(s.getAll())}finally{return n||[]}}function T(e,t,n){return new Promise(async(s,i)=>{const a=(await _()).transaction(e).objectStore(e).index(t),r=[],o=a.openKeyCursor(IDBKeyRange.only(n));o.onsuccess=function(){var e=o.result;e?(r.push(e.primaryKey),e.continue()):(v(),s(r))},o.onerror=function(e){v(),i(e)}})}function O(e,t,n,s){return new Promise(async(i,a)=>{const r=e.transaction(t).objectStore(t).index(n),o=[],c=r.openKeyCursor(IDBKeyRange.only(s));c.onsuccess=function(){var e=c.result;e?(o.push(e.primaryKey),e.continue()):i(o)},c.onerror=function(e){a(e)}})}async function I(e,t,n){try{let s=(await _()).transaction(e,"readwrite").objectStore(e);await j(s.put(t,n))}finally{v()}}async function R(e,t){try{(await _()).transaction(e,"readwrite").objectStore(e).delete(t)}finally{v()}}async function U(e){return new Promise(async(t,n)=>{try{const s=await T("wincache","user_idx",e),i=(await _()).transaction(["users","shelves","stuffs","wincache"],"readwrite"),a=i.objectStore("users"),r=i.objectStore("shelves"),o=i.objectStore("stuffs"),l=i.objectStore("wincache"),u=await j(a.get(e));if(u){const d=u;a.delete(e),r.delete(e),o.delete(e);for(const e of s)l.delete(e);i.oncomplete=()=>{t(d)},i.onabort=e=>{n(c(e))},i.onerror=e=>{n(c(e))}}else n("The user being deleted has not been found!")}catch(e){n(c(e))}finally{v()}})}async function D(e,t){const n=e+"_"+t,s=await L("wincache",n);return s?s.data:null}async function M(e,t,n){const s=e+"_"+t;await I("wincache",{userId:e,packId:t,data:n},s)}function C(){return new Promise(e=>{e()})}class E{_translationStrings;constructor(e){this._translationStrings={};for(const t of Object.keys(e))this._translationStrings[t]=l(e[t])}t=e=>{const t=/^(.+):(.+)$/.exec(e);return t&&t.length>0?this._translationStrings[t[1]][t[2]]??e:e}}class B{t;constructor(e){this.t=e}localizableFields=["label","placeholder","description"];localize(e,t,n){return this.walkSemanticsRecursive(e,t,n)}walkSemanticsRecursive(e,t,n){let s=Array.isArray(e)?[]:{};if(0===Object.keys(e).length)s=e;else for(const i in e)if("object"==typeof e[i]&&"string"!=typeof e[i])s[i]=this.walkSemanticsRecursive(e[i],t,n);else if(this.localizableFields.includes(i)&&"string"==typeof e[i]||n){const n=this.t(e[i],t);s[i]=n}else s[i]=e[i];return s}}function $(e){return`${e.machineName}-${e.majorVersion}.${e.minorVersion}`}class V{_blob;_ourl;_usecount;constructor(e,t=void 0){const n=[(ArrayBuffer,e)];this._blob=t?new Blob(n,{type:t}):new Blob(n),this._usecount=0}getUrl(){return this._ourl||(this._ourl=URL.createObjectURL(this._blob),this._usecount=0),this._usecount++,this._ourl}releaseUrl(){this._ourl&&(this._usecount--,this._usecount<=0&&(URL.revokeObjectURL(this._ourl),this._ourl=void 0))}releaseUrlFore(){this._ourl&&(this._usecount=0,URL.revokeObjectURL(this._ourl),this._ourl=void 0)}}var N,F,z,K;!function(e){e[e.Local=0]="Local",e[e.Storage=1]="Storage",e[e.Service=2]="Service",e[e.Link=3]="Link"}(N||(N={})),function(e){e[e.None=0]="None",e[e.CssUrl=1]="CssUrl"}(F||(F={})),function(e){e[e.Classic=0]="Classic",e[e.Regular=1]="Regular",e[e.VMBook=2]="VMBook"}(z||(z={})),function(e){e[e.Undef=0]="Undef",e[e.Start=1]="Start",e[e.Download=2]="Download",e[e.Parsing=3]="Parsing",e[e.Integration=4]="Integration",e[e.Finish=5]="Finish",e[e.Error=6]="Error"}(K||(K={}));class W{static NOTMATTER_START=" \"'./";static NOTMATTER_END=" \"'/";static processCssUrl(e,t,n=null){function s(e){let t=0,n=e.length;for(let n=0;n<e.length;n++)if(s(e[n])){t=n;break}for(let t=e.length-1;t>=0;t--)if(i(e[t])){n=t+1;break}return 0===t&&n===e.length?e:e.substring(t,n);function s(e){return-1===W.NOTMATTER_START.indexOf(e)}function i(e){return-1===W.NOTMATTER_END.indexOf(e)}}const i=[];let a=0,r=-1,o=-1,c=-1;for(;(o=e.indexOf("url(",r))>=0&&(o+=4,c=e.indexOf(")",o),-1!==c);){r=c+1;let l=e.substring(o,c);l=s(l),l.startsWith("data")||l.startsWith("http")||(n&&(l=n(l)),i.push(e.substring(a,o)),a=c,i.push(t.getObjectURLFlex(l)))}return 0===a?e:(a<e.length&&i.push(e.substring(a)),i.join(""))}}class H{_lib;_libfiles;_libname;_mapDelegates;constructor(e,t){this._lib=e,this._libfiles=t,this._libname=`${this._lib.machineName} ${this._lib.majorVersion}.${this._lib.minorVersion}`,this._mapDelegates=new Map}async initializeAsync(){}dispose(){for(let[e,t]of this._mapDelegates)t.releaseUrlFore();this._mapDelegates.clear()}get token(){return this._lib.token}get libname(){return this._libname}getObjectURL(e){let t=this._mapDelegates.get(e);if(!t){const n=this._libfiles.files.find(t=>t.path===e);if(!n)throw new Error(`ActiveLibrary.getObjectURL: The "${e}" file was not found in the "${this.token}" library!`);if(n.preproc===F.CssUrl){const e=W.processCssUrl(n.text,this,e=>e.split("?")[0]);t=new V(e,o.get(n.extension))}else t=new V(n.data,o.get(n.extension));this._mapDelegates.set(e,t)}return t.getUrl()}getObjectURLFlex(e){const t=this._libfiles.files.find(t=>t.path.indexOf(e)>=0);return t?this.getObjectURL(t.path):""}getPreloadedCss(){return this.getPreloadedUrl(this.metadata.preloadedCss)}getPreloadedJs(){return this.getPreloadedUrl(this.metadata.preloadedJs)}getDependencies(){return(this.metadata.preloadedDependencies||[]).map(e=>({machineName:e.machineName,majorVersion:e.majorVersion,minorVersion:e.minorVersion,token:$(e)}))}get metadata(){return this._lib.metadata}getPreloadedUrl(e){return e?e.filter(e=>!1!==e.render).map(e=>this.getObjectURL(e.path)):[]}}class q{static _mapLibs=new Map;static hasLibrary(e){return this._mapLibs.has(e)}static async getLibrary(e){let t=this._mapLibs.get(e);if(!t){const n=await L("libs",e);if(!n)throw new Error(`LibraryPool.getLibrary: The "${e}" library was not found!`);const s=await L("libfiles",e);new H(n,s),t={lib:new H(n,s),usecount:0},await t.lib.initializeAsync(),this._mapLibs.set(e,t)}return t.usecount++,t.lib}static releaseLibrary(e){let t=this._mapLibs.get(e);t&&(t.usecount--,t.usecount<=0&&(t.lib.dispose(),this._mapLibs.delete(e)))}}let J;function X(){return!!J}function Y(){return J}async function G(e){const t=function(e){for(var t=atob(e),n=new Uint8Array(t.length),s=0;s<t.length;s++)n[s]=t.charCodeAt(s);return n.buffer}(e);J=await window.crypto.subtle.importKey("raw",t,"AES-CBC",!0,["encrypt","decrypt"])}async function Q(){J=void 0}async function Z(e,t){if(!J)throw new Error("The decryption key is missing!");const n={name:"AES-CBC",iv:e};return await window.crypto.subtle.decrypt(n,J,t)}class ee{_refBookWnd;_packId;_iframe;_recPack;_recContent;_libMain;_libRuntime;_aPreloaded;_aDependencyLibTokens;_mapActiveLibs;_mapDelegates;isProtected(e){return!!e.iv}async accessLibrary(e){if(this._mapActiveLibs.has(e))return this._mapActiveLibs.get(e);const t=await q.getLibrary(e);return this._mapActiveLibs.set(e,t),t}async processLibDependencies(e,t){function n(e,t){let n=t.find(t=>t.machineName===e.machineName&&t.majorVersion===e.majorVersion&&t.minorVersion===e.minorVersion);return n?.token||t.find(t=>t.machineName===e.machineName)?.token}const s=n(e,this._aPreloaded);if(!s)throw new Error(`processLibDependencies: Not found the ActualLibToken for ${e.token}!`);const i=(await this.accessLibrary(s)).getDependencies();for(let e=0;e<i.length;e++){const s=i[e],a=n(s,this._aPreloaded);a&&t.indexOf(a)<0&&await this.processLibDependencies(s,t)}if(t.indexOf(s)>=0)throw new Error(`processLibDependencies: It looks like a loop! Token=${s}`);t.push(s)}async createContent(e){let t=[],n=[];for(const e of this._aDependencyLibTokens){const s=await this.accessLibrary(e),i=s.getPreloadedCss(),a=s.getPreloadedJs();t.push(...i),n.push(...a)}t=d.concat(t),n=f.concat(n);const s=await async function(e,t,n,s,i){return{baseUrl:void 0,url:"",postUserStatistics:!1,ajaxPath:"",ajax:{setFinished:"",contentUserData:""},saveFreq:!1,user:void 0,siteUrl:void 0,l10n:{H5P:p.localize(m,"en",!0)},loadedJs:[],loadedCss:[],core:{scripts:[],styles:[]},libraryConfig:{"H5P.MathDisplay":{observers:[{name:"mutationObserver",params:{cooldown:500}},{name:"domChangedListener"}],renderer:{mathjax:{src:"vendor/mathjax/tex-svg.js",config:{extensions:["tex2jax.js"],showMathMenu:!1,jax:["input/TeX","output/HTML-CSS"],tex2jax:{ignoreClass:"ckeditor"},messageStyle:"none"}}}}},contents:{[`cid-${e}`]:{library:i,jsonContent:t,fullScreen:"0",exportUrl:void 0,url:e,displayOptions:{frame:!1,export:!1,embed:!1,copyright:!1,icon:!1},styles:[],scripts:[],contentUrl:"",metadata:{license:s.license||"U",title:s.title||"",defaultLanguage:s.language||"en"}}}}}(this._recPack.id,e,0,this._recPack.metadata,this._libMain.libname);let i=function(e){let t=e.styles.map(e=>`\t\t<link rel="stylesheet" href="${e}"/>`).join("\n    "),n=e.scripts.map(e=>`\t\t<script src="${e}"><\/script>`).join("\n    "),s=JSON.stringify(e.integration,null,2);return function(e,...t){if(!e)return"undefined!";let n=Array.prototype.slice.call(t,0);return 0===n.length?e:(Array.isArray(n[0])&&(n=n[0]),e.replace(/\{(\d+)\}/g,(e,t)=>{const s=n[t];return null!=s?s.toString():""}))}(y,e.viewportScale,t,n,s,e.contentId)}({viewportScale:window.matchMedia("(max-width: 575px)").matches?"0.9":"1.0",contentId:this._recPack.id,styles:t,scripts:n,integration:s});return this._libRuntime=Array.from(this._mapActiveLibs.values()).find(e=>e.libname.startsWith("VMB.Runtime")),i}async build(){try{if(this._recPack=await L("packs",this._packId),!this._recPack)throw new Error(`The package with "${this._packId}" record key was not found!`);this._aPreloaded=(this._recPack.metadata.preloadedDependencies||[]).map(e=>({machineName:e.machineName,majorVersion:e.majorVersion,minorVersion:e.minorVersion,token:$(e)}));const e=this._aPreloaded.find(e=>e.machineName==this._recPack.metadata.mainLibrary);if(!e)throw new Error(`ActivePackage.initializeAsync (${this._recPack.name}): The Main Library (${this._recPack.metadata.mainLibrary}) was not found in the dependencies!`);this._recContent=await L("packcont",this._recPack.id);const t=$(e);this._libMain=await this.accessLibrary(t);for(let e=0;e<this._aPreloaded.length;e++){const t=this._aPreloaded[e];this._aDependencyLibTokens.indexOf(t.token)<0&&await this.processLibDependencies(t,this._aDependencyLibTokens)}let n;if(this.isProtected(this._recContent)){if(!X())throw new Error("The current user is not allowed to view protected content!");{const e=await Z(this._recContent.iv,this._recContent.data);n=(new TextDecoder).decode(e)}}else n=this._recContent.data;const s=function(e){const t=[];for(const n in h){const s=h[n];for(const n of s.addTo.content.types)if(n.text){const i=/^\/(.+?)\/([gimy]+)?$/.exec(n.text.regex);if(!i||i.length<1){console.error(`The addon ${s.token} contains an invalid regexp pattern in the addTo selector: ${n.text.regex}. This will be silently ignored, but the addon will never be used!`);continue}new RegExp(i[1],i[2]).test(e)&&t.push(s)}}return t}(n);for(const e of s)await this.processLibDependencies(e,this._aDependencyLibTokens);this._iframe.contentWindow.VMB={isBookRT:!0};const i=await this.createContent(n),a=this._iframe.contentWindow?.document;if(!a)throw new Error("The iframe element with the correct structure was not created.");a.write(i),a.close(),this._iframe.contentWindow.ActivePackage=this,this._iframe.addEventListener("load",e=>{const t=this._iframe.contentWindow;t&&t.H5P&&t.H5P.externalDispatcher?t.H5P.externalDispatcher.on("xAPI",this._onH5PxAPI.bind(this)):console.error("ActivePackage.build: Error initializing the H5P work environment!")}),await this._refBookWnd.invokeMethodAsync("notifyRenderComplete")}catch(e){await this._refBookWnd.invokeMethodAsync("notifyRenderError",c(e))}}getObjectURL(e){let t=this._mapDelegates.get(e);if(!t){const n=this._recContent.files.find(t=>t.path===e);if(!n)throw new Error(`ActivePackage.getObjectURL: The "${e}" file was not found in the "${this._recPack.name}" package!`);t=new V(n.data,o.get(n.extension)),this._mapDelegates.set(e,t)}return t.getUrl()}getObjectURLFlex(e){const t=this._recContent.files.find(t=>t.path.indexOf(e)>=0);return t?this.getObjectURL(t.path):""}_onH5PxAPI(e){if(e.data&&e.data.statement&&e.data.statement.result){const t=e.data.statement.result;t.completion,t.success}}getActiveLibrary(e){return this._mapActiveLibs.get(e)}getRuntimeLibrary(){return this._libRuntime}constructor(e,t,n){this._refBookWnd=e,this._packId=t,this._iframe=n,this._aPreloaded=[],this._aDependencyLibTokens=[],this._mapActiveLibs=new Map,this._mapDelegates=new Map,setTimeout(async()=>{await this.build()},10)}dispose(){this._iframe&&(this._iframe.contentWindow?.close(),this._iframe.remove()),this._mapActiveLibs.forEach(e=>{q.releaseLibrary(e.token)}),this._mapActiveLibs.clear(),this._mapDelegates.forEach(e=>{e.releaseUrlFore()}),this._mapDelegates.clear()}}const te=new Map;function ne(e,t,n){const s=new ee(e,t,n);te.set(t,s)}function se(e){return te.has(e)}function ie(e){te.has(e)&&(te.get(e)?.dispose(),te.delete(e))}function ae(){te.forEach(e=>e.dispose()),te.clear()}let re,oe,ce;const le=[];function ue(){return new Worker(new URL(e.p+e.u(303),e.b),{type:"module"})}function de(){return new Worker(new URL(e.p+e.u(54),e.b),{type:"module"})}function fe(e){const t=le.findIndex(t=>t.worker===e);t>=0&&(e.terminate(),le.splice(t,1))}async function he(){function e(e,t){e&&fe(e),re.invokeMethodAsync("InformLibInstallError",t)}try{if(ce.files.length>=1){const t=ce.files[0],n={name:t.name,size:t.size,type:t.type,modified:t.lastModified};if(await re.invokeMethodAsync("RequestLibInstall",t.name)){const s=ue();s.onerror=t=>{e(s,c(t))},s.addEventListener("message",async t=>{const n=t.data;switch(!0){case void 0!==n.libBrief:re.invokeMethodAsync("InformLibInstallFinish",n.libBrief),fe(s);break;case"string"==typeof n.message:e(s,n.message)}}),le.push({worker:s,id:n.name,monitor:null}),s.postMessage({libFile:t,params:{},cryptoKey:Y()})}}}catch(t){e(null,c(t))}}async function pe(){if(oe.files.length>=1){const e=oe.files[0],t=await re.invokeMethodAsync("MonitorRequest",{FileName:e.name}),[n,s,i]=[t.bookRef,t.bookMonitor,t.params];n.source=e,ge(n,s,i)}}function me(e){oe=e,oe&&oe.addEventListener("change",pe)}function ye(e){ce=e,ce&&ce.addEventListener("change",he)}function be(){oe&&oe.click()}async function ge(e,t,n){function s(e,n){e&&fe(e),t.invokeMethodAsync("InformSetupError",n)}const i=ue();i.onerror=e=>{s(i,c(e))},i.addEventListener("message",async e=>{const a=e.data;switch(!0){case void 0!==a.phase:switch(a.phase){case K.Download:case K.Parsing:case K.Integration:t.invokeMethodAsync("InformSetupProgress",a.phase,a.percent);break;case K.Finish:fe(e.currentTarget),t.invokeMethodAsync("InformSetupFinish",a.bookCase);break;default:s(i,e.data.message)}break;case void 0!==a.match:switch(await t.invokeMethodAsync("RequestPackUpdate",a.candidate,a.existing,a.match)){case 0:i.postMessage({setupVariant:"update"});break;case 1:i.postMessage({setupVariant:"install"});break;default:fe(e.currentTarget),t.invokeMethodAsync("InformSetupFinish",null)}break;case void 0!==a.candidate:i.postMessage({setupVariant:n.isUpdate?"update":"install"})}}),le.push({worker:i,id:e.id,monitor:t}),i.postMessage({bookRef:e,params:{...n},cryptoKey:Y()})}async function we(e){const t=le.find(t=>t.id===e);t&&(fe(t.worker),t.monitor&&t.monitor.invokeMethodAsync("InformSetupAborted"))}async function ke(e,t,n){function s(e,n){e&&fe(e),re.invokeMethodAsync("InformUninstallError",t,n)}const i=de();i.onerror=e=>{s(i,c(e))},le.push({worker:i,id:e,monitor:null}),i.addEventListener("message",async e=>{const t=e.data;switch(t.msgtype){case"done":setTimeout(()=>{re.invokeMethodAsync("InformUninstalled",t.bookCase)},0);break;case"error":s(i,t.message)}fe(i)}),i.postMessage({bookId:e,bookName:t,params:{...n}})}function _e(){ce&&ce.click()}function ve(e){if(q.hasLibrary(e.key))throw new Error(`You cannot delete a library that is in use! (library: ${e.key})`);!async function(e){function t(t,n){t&&fe(t),re.invokeMethodAsync("InformLibUnnstallError",e,n)}const n=de();n.onerror=e=>{t(n,c(e))},le.push({worker:n,id:e.key,monitor:null}),n.addEventListener("message",async s=>{const i=s.data;switch(i.msgtype){case"done":fe(n),setTimeout(()=>{re.invokeMethodAsync("InformLibUninstallFinish",e)},0);break;case"error":t(n,i.message)}}),n.postMessage({libBrief:e,params:{}})}(e)}async function je(e,t){re=e}class Le{id;origId;name;version;isPopup;packtype;sourceType;suiteid;filename;filesize;modified;isBroken;constructor(e){this.id=e.id,this.origId=e.origId,this.name=e.name,this.version=e.version,this.isPopup=e.isPopup,this.packtype=e.packtype||z.Classic,this.sourceType=e.sourceType,this.suiteid=e.suiteid,this.filename=e.fileinfo.fullname,this.filesize=e.fileinfo.size,this.modified=e.fileinfo.modified,this.isBroken=e.isBroken}}let xe;function Pe(e,t){let n=0;const s=new RegExp(`PackageId=("|')${e}`);for(const e of t)s.test(e.data)&&n++;return n}function Ae(e,t){if(!e)return"";const n=t.find(t=>t.key===e);return n?n.name:""}function Se(e,t,n){return{id:e.id,origId:e.origId,version:e.version||"0.0.0",isPopup:e.isPopup,name:e.name,packtype:e.packtype,sourceType:e.sourceType,sourceUrl:e.sourceUrl,suiteid:e.suiteid,suitename:Ae(e.suiteid,n),filename:e.fileinfo.fullname,filesize:e.fileinfo.size,modified:e.fileinfo.modified,installed:e.installed,updated:e.updated,isBroken:e.isBroken,brokeninfo:e.brokeninfo,refcount:Pe(e.id,t)}}async function Te(){return new Promise(async(e,t)=>{try{let t=await _();const n=await S(t,"shelves"),s=(await S(t,"suites")).map(e=>e);let i=t.transaction("packs","readonly").objectStore("packs");const a=[];i.openCursor().onsuccess=t=>{const i=t.target.result;if(i){const e=Se(i.value,n,s);a.push(e),i.continue()}else v(),e(a)}}catch(e){v(),t(e)}})}async function Oe(e){let t=await _(),n=null;const s=await x(t,"packs",e);return s&&(n=Se(s,await S(t,"shelves"),(await S(t,"suites")).map(e=>e))),v(),n}async function Ie(){return new Promise(async(e,t)=>{try{let t=(await _()).transaction("packs","readonly").objectStore("packs");const n=[];t.openCursor().onsuccess=t=>{const s=t.target.result;if(s){const e=s.value,t=new Le(e);n.push(t),s.continue()}else v(),e(n)}}catch(e){v(),t(e)}})}async function Re(e){return!!(await L("packext",e)).annotation}async function Ue(e){return(await L("packext",e)).annotation||""}async function De(e){return(await L("packext",e)).cover||""}async function Me(e){const t=await L("packext",e);return{hasOverview:!!t.annotation,cover:t.cover}}async function Ce(){return new Promise(async(e,t)=>{function n(e,t){e&&e.length>0&&e.forEach(e=>{const n=$(e);s.has(n)||s.set(n,{packrefs:0,librefs:0});const i=s.get(n);t?i.packrefs=i.packrefs+1:i.librefs=i.librefs+1,s.set(n,i)})}const s=new Map;try{let t=await _();const i=[];(await A("packs")).forEach(e=>{n(e.metadata.preloadedDependencies,!0)}),t.transaction("libs","readonly").objectStore("libs").openCursor().onsuccess=t=>{const a=t.target.result;if(a){const e=a.value,t={};t.libtoken=a.key.toString(),t.image=(e.metadata.machineName,"assets/images/etc/library.svg"),t.version=`${e.metadata.majorVersion}.${e.metadata.minorVersion}.${e.metadata.patchVersion}`,t.title=e.metadata.title,t.license=e.metadata.license||"",t.author=e.metadata.author||"",t.description=e.metadata.description||"",t.fullscreen=1==e.metadata.fullscreen,t.isAddon=1==e.isAddon,t.packrefs=0,t.librefs=0,n(e.metadata.preloadedDependencies,!1),i.push(t),a.continue()}else v(),i.forEach(e=>{if(s.has(e.libtoken)){const t=s.get(e.libtoken);e.packrefs=t.packrefs,e.librefs=t.librefs}}),e(i)}}catch(e){v(),t(e)}})}async function Ee(e,t=null){const n=new RegExp(`PackageId=("|')${e}`);var s=await A("shelves");for(let e=0;e<s.length;e++){const i=s[e];if((!t||i.userId!=t)&&n.test(i.data))return!0}return!1}async function Be(e){return new Promise(async(t,n)=>{try{(await _()).transaction("packs","readonly").objectStore("packs").openCursor().onsuccess=n=>{const s=n.target.result;if(s){const n=s.value;if(n.fileinfo.name===e.filename&&n.fileinfo.size===e.filesize&&n.fileinfo.modified){const e=new Le(n);return void t(e)}s.continue()}else t(null)}}catch(e){n(e)}finally{v()}})}async function $e(e){xe=e,await async function(e){b=e,d=["vendor/h5p/styles/font-open-sans.css","vendor/h5p/styles/h5p.bundle.css"],f=["vendor/h5p/h5p.bundle.js"],h=await L("_system","addons")||{},m=await r("assets/h5p-strings/default.json");let t=await r("assets/h5p-strings/en.json");p=new B(new E({client:t}).t),y=await new Promise((e,t)=>{fetch("assets/templates/h5pplayer.txt").then(n=>{!0===n.ok?e(n.text()):t(c(n))})})}(xe)}function Ve(){return t}function Ne(){return s}function Fe(){return n}function ze(){return i}function Ke(){return a}export{Ne as getActivePoolModule,Ve as getAppDBModule,Fe as getCryptoModule,Ke as getManagerModule,ze as getSetupperModule};