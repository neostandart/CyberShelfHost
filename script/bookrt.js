var e={m:{},d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},u:e=>303===e?"install-worker.2b543871.js":54===e?"uninstall-worker.d7d023a0.js":void 0,o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}};(()=>{var t;if("string"==typeof import.meta.url&&(t=import.meta.url),!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),e.p=t})(),e.b=new URL("./",import.meta.url);var t={};e.r(t),e.d(t,{delObject:()=>T,delUser:()=>I,get:()=>_,getAll:()=>P,getAllFrom:()=>x,getByKeys:()=>L,getFrom:()=>j,getKeysByIndex:()=>A,getKeysByIndexFrom:()=>S,getWinCache:()=>E,initializeAsync:()=>R,processStoreRequest:()=>v,put:()=>O,releaseDB:()=>k,setWinCache:()=>M,useDB:()=>w});var n={};e.r(n),e.d(n,{decrypt:()=>G,discardCryptoKey:()=>Y,getCryptoKey:()=>J,hasCryptoKey:()=>q,importCryptoKey:()=>X});var i={};e.r(i),e.d(i,{clear:()=>ie,hasPackage:()=>te,remove:()=>ne,render:()=>ee});var s={};e.r(s),e.d(s,{abort:()=>be,attachLibraryInput:()=>pe,attachPackageInput:()=>he,initialize:()=>ve,invokeBookInstall:()=>me,invokeLibraryInstall:()=>we,invokeLibraryUninstall:()=>ke,setup:()=>ye,uninstallBook:()=>ge});var r={};function a(e){return new Promise((t,n)=>{fetch(e).then(e=>{!0===e.ok?t(e.json()):n(c(e))})})}e.r(r),e.d(r,{fetchBookCases:()=>Oe,fetchBookCover:()=>Ee,fetchBookInfo:()=>Se,fetchBookInfoList:()=>Ae,fetchBookOverview:()=>Ie,fetchLibraryList:()=>Re,findPackageByFile:()=>De,getBookOverviewPrompt:()=>Me,hasBookOverview:()=>Te,hasPackageRefs:()=>Ue,initializeAsync:()=>Be});const o=new Map([["css","text/css"],["js","application/x-javascript"],["json","application/json"],["docx","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],["ico","image/x-icon"],["jpeg","image/jpeg"],["jpg","image/jpeg"],["png","image/png"],["svg","image/svg+xml"],["bmp","image/bmp"],["mp3","audio/mpeg"],["mpeg","video/mpeg"],["mpg","video/mpeg"],["wma","audio/x-ms-wma"],["wav","audio/wav"]]);function c(e){let t="";if(e instanceof Event)if(e.target instanceof IDBOpenDBRequest){const t=e.target;t.error&&(e=t.error)}else e.message&&(t=e.message);else if(e instanceof Error){const n=e;t=n.name,t.endsWith(".")||(t+="."),n.message&&(t+=" "+n.message)}else if(e instanceof Response){const i=e;t=n(`Response: ok=${i.ok}; status=${i.status}; statusText=${i.statusText}; type=${i.type}; url=${i.url}.`)}else"string"==typeof e?t=e:(e&&e.name&&(t=n(e.name)),e&&e.status&&(t=n(`status=${e.status}`)),e&&e.statusText&&(t=n(`statusText=${e.statusText}`)));return t;function n(e){return t.length>0?t+=` | ${e}`:e}}function l(e,t){const n=(t=t||{}).delimiter||".",i=t.maxDepth,s=t.transformKey||function(e){return e},r={};return function e(a,o,c){c=c||1,Object.keys(a).forEach(function(l){const u=a[l],d=t.safe&&Array.isArray(u),f=Object.prototype.toString.call(u),h=(p=u)&&p.constructor&&"function"==typeof p.constructor.isBuffer&&p.constructor.isBuffer(p);var p;const m="[object Object]"===f||"[object Array]"===f,y=o?o+n+s(l):s(l);if(!d&&!h&&m&&Object.keys(u).length&&(!t.maxDepth||c<i))return e(u,y,c+1);r[y]=u})}(e,void 0,void 0),r}const u="AppDB";let d,f,h,p,m,y=1,b=0,g=null;function w(){return b++,new Promise((e,t)=>{if(g)e(g);else{let n=indexedDB.open(u,y);n.onerror=e=>{let n=c(e);t(new Error("AppDB Error: "+n))},n.onblocked=e=>{t(new Error("AppDB Failure: The application database is blocked"))},n.onsuccess=t=>{let n=t.target;g=n.result,e(g)},n.onupgradeneeded=e=>{!function(e){let t=e.target.result;e.oldVersion<3&&(function(){const e=t.objectStoreNames;for(let n=0;n<e.length;n++)t.deleteObjectStore(e[n])}(),function(){t.createObjectStore("_system"),t.createObjectStore("shared"),t.createObjectStore("users"),t.createObjectStore("shelves"),t.createObjectStore("stuffs"),t.createObjectStore("results"),t.createObjectStore("suites"),t.createObjectStore("packs"),t.createObjectStore("packcont"),t.createObjectStore("packext");const e=t.createObjectStore("wincache");e.createIndex("user_idx","userId"),e.createIndex("pack_idx","packId"),t.createObjectStore("libs"),t.createObjectStore("libfiles")}())}(e)}}})}function k(){b--,b<1&&(b=0,g&&(g.close(),g=null))}function v(e){return new Promise((t,n)=>{e.onsuccess=n=>{n.target instanceof IDBRequest?(e=n.target,t(e.result)):t(void 0)},e.onerror=e=>{n(e)}})}async function _(e,t){let n;try{let i=(await w()).transaction(e,"readonly").objectStore(e);n=await v(i.get(t))}finally{return k(),n}}async function j(e,t,n){let i=e.transaction(t,"readonly").objectStore(t);return await v(i.get(n))}async function L(e,t){return new Promise(async(n,i)=>{const s=[];let r=(await w()).transaction(e).objectStore(e).openCursor();r.onsuccess=e=>{const i=e.target.result;i?(t.findIndex(e=>i.key==e)>=0&&s.push(i.value),i.continue()):(k(),n(s))},r.onerror=e=>{k(),i(c(e))}})}async function P(e){let t;try{let n=(await w()).transaction(e,"readonly").objectStore(e);t=await v(n.getAll())}finally{return k(),t||[]}}async function x(e,t){let n;try{let i=e.transaction(t,"readonly").objectStore(t);n=await v(i.getAll())}finally{return n||[]}}function A(e,t,n){return new Promise(async(i,s)=>{const r=(await w()).transaction(e).objectStore(e).index(t),a=[],o=r.openKeyCursor(IDBKeyRange.only(n));o.onsuccess=function(){var e=o.result;e?(a.push(e.primaryKey),e.continue()):(k(),i(a))},o.onerror=function(e){k(),s(e)}})}function S(e,t,n,i){return new Promise(async(s,r)=>{const a=e.transaction(t).objectStore(t).index(n),o=[],c=a.openKeyCursor(IDBKeyRange.only(i));c.onsuccess=function(){var e=c.result;e?(o.push(e.primaryKey),e.continue()):s(o)},c.onerror=function(e){r(e)}})}async function O(e,t,n){try{let i=(await w()).transaction(e,"readwrite").objectStore(e);await v(i.put(t,n))}finally{k()}}async function T(e,t){try{(await w()).transaction(e,"readwrite").objectStore(e).delete(t)}finally{k()}}async function I(e){return new Promise(async(t,n)=>{try{const i=await A("wincache","user_idx",e),s=(await w()).transaction(["users","shelves","stuffs","wincache"],"readwrite"),r=s.objectStore("users"),a=s.objectStore("shelves"),o=s.objectStore("stuffs"),l=s.objectStore("wincache"),u=await v(r.get(e));if(u){const d=u;r.delete(e),a.delete(e),o.delete(e);for(const e of i)l.delete(e);s.oncomplete=()=>{t(d)},s.onabort=e=>{n(c(e))},s.onerror=e=>{n(c(e))}}else n("The user being deleted has not been found!")}catch(e){n(c(e))}finally{k()}})}async function E(e,t){const n=e+"_"+t,i=await _("wincache",n);return i?i.data:null}async function M(e,t,n){const i=e+"_"+t;await O("wincache",{userId:e,packId:t,data:n},i)}function R(){return new Promise(e=>{e()})}class U{_translationStrings;constructor(e){this._translationStrings={};for(const t of Object.keys(e))this._translationStrings[t]=l(e[t])}t=e=>{const t=/^(.+):(.+)$/.exec(e);return t&&t.length>0?this._translationStrings[t[1]][t[2]]??e:e}}class D{t;constructor(e){this.t=e}localizableFields=["label","placeholder","description"];localize(e,t,n){return this.walkSemanticsRecursive(e,t,n)}walkSemanticsRecursive(e,t,n){let i=Array.isArray(e)?[]:{};if(0===Object.keys(e).length)i=e;else for(const s in e)if("object"==typeof e[s]&&"string"!=typeof e[s])i[s]=this.walkSemanticsRecursive(e[s],t,n);else if(this.localizableFields.includes(s)&&"string"==typeof e[s]||n){const n=this.t(e[s],t);i[s]=n}else i[s]=e[s];return i}}function B(e){return`${e.machineName}-${e.majorVersion}.${e.minorVersion}`}class C{_blob;_ourl;_usecount;constructor(e,t=void 0){const n=[(ArrayBuffer,e)];this._blob=t?new Blob(n,{type:t}):new Blob(n),this._usecount=0}getUrl(){return this._ourl||(this._ourl=URL.createObjectURL(this._blob),this._usecount=0),this._usecount++,this._ourl}releaseUrl(){this._ourl&&(this._usecount--,this._usecount<=0&&(URL.revokeObjectURL(this._ourl),this._ourl=void 0))}releaseUrlFore(){this._ourl&&(this._usecount=0,URL.revokeObjectURL(this._ourl),this._ourl=void 0)}}var $,V,N,F;!function(e){e[e.Local=0]="Local",e[e.Storage=1]="Storage",e[e.Service=2]="Service",e[e.Link=3]="Link"}($||($={})),function(e){e[e.None=0]="None",e[e.CssUrl=1]="CssUrl"}(V||(V={})),function(e){e[e.Classic=0]="Classic",e[e.Regular=1]="Regular",e[e.VMBook=2]="VMBook"}(N||(N={})),function(e){e[e.Undef=0]="Undef",e[e.Start=1]="Start",e[e.Download=2]="Download",e[e.Parsing=3]="Parsing",e[e.Integration=4]="Integration",e[e.Finish=5]="Finish",e[e.Error=6]="Error"}(F||(F={}));class z{static NOTMATTER_START=" \"'./";static NOTMATTER_END=" \"'/";static processCssUrl(e,t,n=null){function i(e){let t=0,n=e.length;for(let n=0;n<e.length;n++)if(i(e[n])){t=n;break}for(let t=e.length-1;t>=0;t--)if(s(e[t])){n=t+1;break}return 0===t&&n===e.length?e:e.substring(t,n);function i(e){return-1===z.NOTMATTER_START.indexOf(e)}function s(e){return-1===z.NOTMATTER_END.indexOf(e)}}const s=[];let r=0,a=-1,o=-1,c=-1;for(;(o=e.indexOf("url(",a))>=0&&(o+=4,c=e.indexOf(")",o),-1!==c);){a=c+1;let l=e.substring(o,c);l=i(l),l.startsWith("data")||l.startsWith("http")||(n&&(l=n(l)),s.push(e.substring(r,o)),r=c,s.push(t.getObjectURLFlex(l)))}return 0===r?e:(r<e.length&&s.push(e.substring(r)),s.join(""))}}class W{_lib;_libfiles;_libname;_mapDelegates;constructor(e,t){this._lib=e,this._libfiles=t,this._libname=`${this._lib.machineName} ${this._lib.majorVersion}.${this._lib.minorVersion}`,this._mapDelegates=new Map}async initializeAsync(){}dispose(){for(let[e,t]of this._mapDelegates)t.releaseUrlFore();this._mapDelegates.clear()}get token(){return this._lib.token}get libname(){return this._libname}getObjectURL(e){let t=this._mapDelegates.get(e);if(!t){const n=this._libfiles.files.find(t=>t.path===e);if(!n)throw new Error(`ActiveLibrary.getObjectURL: The "${e}" file was not found in the "${this.token}" library!`);if(n.preproc===V.CssUrl){const e=z.processCssUrl(n.text,this,e=>e.split("?")[0]);t=new C(e,o.get(n.extension))}else t=new C(n.data,o.get(n.extension));this._mapDelegates.set(e,t)}return t.getUrl()}getObjectURLFlex(e){const t=this._libfiles.files.find(t=>t.path.indexOf(e)>=0);return t?this.getObjectURL(t.path):""}getPreloadedCss(){return this.getPreloadedUrl(this.metadata.preloadedCss)}getPreloadedJs(){return this.getPreloadedUrl(this.metadata.preloadedJs)}getDependencies(){return(this.metadata.preloadedDependencies||[]).map(e=>({machineName:e.machineName,majorVersion:e.majorVersion,minorVersion:e.minorVersion,token:B(e)}))}get metadata(){return this._lib.metadata}getPreloadedUrl(e){return e?e.filter(e=>!1!==e.render).map(e=>this.getObjectURL(e.path)):[]}}class K{static _mapLibs=new Map;static hasLibrary(e){return this._mapLibs.has(e)}static async getLibrary(e){let t=this._mapLibs.get(e);if(!t){const n=await _("libs",e);if(!n)throw new Error(`LibraryPool.getLibrary: The "${e}" library was not found!`);const i=await _("libfiles",e);new W(n,i),t={lib:new W(n,i),usecount:0},await t.lib.initializeAsync(),this._mapLibs.set(e,t)}return t.usecount++,t.lib}static releaseLibrary(e){let t=this._mapLibs.get(e);t&&(t.usecount--,t.usecount<=0&&(t.lib.dispose(),this._mapLibs.delete(e)))}}let H;function q(){return!!H}function J(){return H}async function X(e){const t=function(e){for(var t=atob(e),n=new Uint8Array(t.length),i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return n.buffer}(e);H=await crypto.subtle.importKey("raw",t,"AES-CBC",!0,["encrypt","decrypt"])}async function Y(){H=void 0}async function G(e,t,n=void 0){if(!n){if(!H)throw new Error("The decryption key is missing!");n=H}const i={name:"AES-CBC",iv:e};return await crypto.subtle.decrypt(i,n,t)}class Q{_refBookWnd;_packId;_iframe;_iframeParentElement;_recPack;_recContent;_libMain;_libRuntime;_aPreloaded;_aDependencyLibTokens;_mapActiveLibs;_mapDelegates;isProtected(e){return!!e.iv}async accessLibrary(e){if(this._mapActiveLibs.has(e))return this._mapActiveLibs.get(e);const t=await K.getLibrary(e);return this._mapActiveLibs.set(e,t),t}async processLibDependencies(e,t){function n(e,t){let n=t.find(t=>t.machineName===e.machineName&&t.majorVersion===e.majorVersion&&t.minorVersion===e.minorVersion);return n?.token||t.find(t=>t.machineName===e.machineName)?.token}const i=n(e,this._aPreloaded);if(!i)throw new Error(`processLibDependencies: Not found the ActualLibToken for ${e.token}!`);const s=(await this.accessLibrary(i)).getDependencies();for(let e=0;e<s.length;e++){const i=s[e],r=n(i,this._aPreloaded);r&&t.indexOf(r)<0&&await this.processLibDependencies(i,t)}if(t.indexOf(i)>=0)throw new Error(`processLibDependencies: It looks like a loop! Token=${i}`);t.push(i)}async prepareHtmlPage(e){let t=[],n=[];for(const e of this._aDependencyLibTokens){const i=await this.accessLibrary(e),s=i.getPreloadedCss(),r=i.getPreloadedJs();t.push(...s),n.push(...r)}const i=await async function(e,t,n,i,s){return{baseUrl:void 0,url:"",postUserStatistics:!1,ajaxPath:"",ajax:{setFinished:"",contentUserData:""},saveFreq:!1,user:void 0,siteUrl:void 0,l10n:{H5P:f.localize(h,"en",!0)},loadedJs:[],loadedCss:[],core:{scripts:[],styles:[]},libraryConfig:{"H5P.MathDisplay":{observers:[{name:"mutationObserver",params:{cooldown:500}},{name:"domChangedListener"}],renderer:{mathjax:{src:"vendor/mathjax/tex-svg.js",config:{extensions:["tex2jax.js"],showMathMenu:!1,jax:["input/TeX","output/HTML-CSS"],tex2jax:{ignoreClass:"ckeditor"},messageStyle:"none"}}}}},contents:{[`cid-${e}`]:{library:s,jsonContent:t,fullScreen:"0",exportUrl:void 0,url:e,displayOptions:{frame:!1,export:!1,embed:!1,copyright:!1,icon:!1},styles:[],scripts:[],contentUrl:"",metadata:{license:i.license||"U",title:i.title||"",defaultLanguage:i.language||"en"}}}}}(this._recPack.id,e,0,this._recPack.metadata,this._libMain.libname);let s=function(e){let t=e.styles.map(e=>`\t\t<link rel="stylesheet" href="${e}"/>`).join("\n    "),n=e.scripts.map(e=>`\t\t<script src="${e}"><\/script>`).join("\n    "),i=JSON.stringify(e.integration,null,2);return function(e,...t){if(!e)return"undefined!";let n=Array.prototype.slice.call(t,0);return 0===n.length?e:(Array.isArray(n[0])&&(n=n[0]),e.replace(/\{(\d+)\}/g,(e,t)=>{const i=n[t];return null!=i?i.toString():""}))}(p,e.viewportScale,t,n,i,e.contentId)}({viewportScale:window.matchMedia("(max-width: 575px)").matches?"0.9":"1.0",contentId:this._recPack.id,styles:t,scripts:n,integration:i});return this._libRuntime=Array.from(this._mapActiveLibs.values()).find(e=>e.libname.startsWith("VMB.Runtime")),s}async build(){try{if(this._recPack=await _("packs",this._packId),!this._recPack)throw new Error(`The package with "${this._packId}" record key was not found!`);this._aPreloaded=(this._recPack.metadata.preloadedDependencies||[]).map(e=>({machineName:e.machineName,majorVersion:e.majorVersion,minorVersion:e.minorVersion,token:B(e)}));const e=this._aPreloaded.find(e=>e.machineName==this._recPack.metadata.mainLibrary);if(!e)throw new Error(`ActivePackage.initializeAsync (${this._recPack.name}): The Main Library (${this._recPack.metadata.mainLibrary}) was not found in the dependencies!`);this._recContent=await _("packcont",this._recPack.id);const t=B(e);this._libMain=await this.accessLibrary(t);for(let e=0;e<this._aPreloaded.length;e++){const t=this._aPreloaded[e];this._aDependencyLibTokens.indexOf(t.token)<0&&await this.processLibDependencies(t,this._aDependencyLibTokens)}let n;if(this.isProtected(this._recContent)){if(!q())throw new Error("ActivePackage.build: the current user is not allowed to view protected content!");{const e=await G(this._recContent.iv,this._recContent.data);n=(new TextDecoder).decode(e)}}else n=this._recContent.data;const i=function(e){const t=[];for(const n in d){const i=d[n];for(const n of i.addTo.content.types)if(n.text){const s=/^\/(.+?)\/([gimy]+)?$/.exec(n.text.regex);if(!s||s.length<1){console.error(`The addon ${i.token} contains an invalid regexp pattern in the addTo selector: ${n.text.regex}. This will be silently ignored, but the addon will never be used!`);continue}new RegExp(s[1],s[2]).test(e)&&t.push(i)}}return t}(n);for(const e of i)await this.processLibDependencies(e,this._aDependencyLibTokens);if(this._iframe.srcdoc=await this.prepareHtmlPage(n),this._iframeParentElement.appendChild(this._iframe),!this._iframe.contentWindow)throw new Error("ActivePackage.build: couldn't access contentWindow");{const e=this._iframe.contentWindow.parent;e.VMB={isBookRT:!0},e.ActivePackage=this,this._iframe.contentWindow.VMB=e.VMB,this._iframe.contentWindow.ActivePackage=e.ActivePackage}this._iframe.addEventListener("load",e=>{const t=this._iframe.contentWindow;t&&t.H5P&&t.H5P.externalDispatcher?t.H5P.externalDispatcher.on("xAPI",this._onH5PxAPI.bind(this)):console.error("ActivePackage.build: Error initializing the H5P work environment!")}),await this._refBookWnd.invokeMethodAsync("notifyRenderComplete")}catch(e){await this._refBookWnd.invokeMethodAsync("notifyRenderError",c(e))}}getObjectURL(e){let t=this._mapDelegates.get(e);if(!t){const n=this._recContent.files.find(t=>t.path===e);if(!n)throw new Error(`ActivePackage.getObjectURL: The "${e}" file was not found in the "${this._recPack.name}" package!`);t=new C(n.data,o.get(n.extension)),this._mapDelegates.set(e,t)}return t.getUrl()}getObjectURLFlex(e){const t=this._recContent.files.find(t=>t.path.indexOf(e)>=0);return t?this.getObjectURL(t.path):""}_onH5PxAPI(e){if(e.data&&e.data.statement&&e.data.statement.result){const t=e.data.statement.result;t.completion,t.success}}getActiveLibrary(e){return this._mapActiveLibs.get(e)}getRuntimeLibrary(){return this._libRuntime}constructor(e,t,n){this._refBookWnd=e,this._packId=t,this._iframe=n,this._iframeParentElement=this._iframe.parentElement,this._iframe.remove(),this._aPreloaded=[],this._aDependencyLibTokens=[],this._mapActiveLibs=new Map,this._mapDelegates=new Map,setTimeout(async()=>{await this.build()},10)}dispose(){this._iframe&&(this._iframe.contentWindow?.close(),this._iframe.remove()),this._mapActiveLibs.forEach(e=>{K.releaseLibrary(e.token)}),this._mapActiveLibs.clear(),this._mapDelegates.forEach(e=>{e.releaseUrlFore()}),this._mapDelegates.clear()}}const Z=new Map;function ee(e,t,n){const i=new Q(e,t,n);Z.set(t,i)}function te(e){return Z.has(e)}function ne(e){Z.has(e)&&(Z.get(e)?.dispose(),Z.delete(e))}function ie(){Z.forEach(e=>e.dispose()),Z.clear()}let se,re,ae;const oe=[];function ce(){return new Worker(new URL(e.p+e.u(303),e.b),{type:"module"})}function le(){return new Worker(new URL(e.p+e.u(54),e.b),{type:"module"})}function ue(e){const t=oe.findIndex(t=>t.worker===e);t>=0&&(e.terminate(),oe.splice(t,1))}async function de(){function e(e,t){e&&ue(e),se.invokeMethodAsync("InformLibInstallError",t)}try{if(ae.files.length>=1){const t=ae.files[0],n={name:t.name,size:t.size,type:t.type,modified:t.lastModified};if(await se.invokeMethodAsync("RequestLibInstall",t.name)){const i=ce();i.onerror=t=>{e(i,c(t))},i.addEventListener("message",async t=>{const n=t.data;switch(!0){case void 0!==n.libBrief:se.invokeMethodAsync("InformLibInstallFinish",n.libBrief),ue(i);break;case"string"==typeof n.message:e(i,n.message)}}),oe.push({worker:i,id:n.name,monitor:null}),i.postMessage({libFile:t,params:{},cryptoKey:J()})}}}catch(t){e(null,c(t))}}async function fe(){if(re.files.length>=1){const e=re.files[0],t=await se.invokeMethodAsync("MonitorRequest",{FileName:e.name}),[n,i,s]=[t.bookRef,t.bookMonitor,t.params];n.source=e,ye(n,i,s)}}function he(e){re=e,re&&re.addEventListener("change",fe)}function pe(e){ae=e,ae&&ae.addEventListener("change",de)}function me(){re&&re.click()}async function ye(e,t,n){function i(e,n){e&&ue(e),t.invokeMethodAsync("InformSetupError",n)}const s=ce();s.onerror=e=>{i(s,c(e))},s.addEventListener("message",async e=>{const r=e.data;switch(!0){case void 0!==r.phase:switch(r.phase){case F.Download:case F.Parsing:case F.Integration:t.invokeMethodAsync("InformSetupProgress",r.phase,r.percent);break;case F.Finish:ue(e.currentTarget),t.invokeMethodAsync("InformSetupFinish",r.bookCase);break;default:i(s,e.data.message)}break;case void 0!==r.match:switch(await t.invokeMethodAsync("RequestPackUpdate",r.candidate,r.existing,r.match)){case 0:s.postMessage({setupVariant:"update"});break;case 1:s.postMessage({setupVariant:"install"});break;default:ue(e.currentTarget),t.invokeMethodAsync("InformSetupFinish",null)}break;case void 0!==r.candidate:s.postMessage({setupVariant:n.isUpdate?"update":"install"})}}),oe.push({worker:s,id:e.id,monitor:t}),s.postMessage({bookRef:e,params:{...n},cryptoKey:J()})}async function be(e){const t=oe.find(t=>t.id===e);t&&(ue(t.worker),t.monitor&&t.monitor.invokeMethodAsync("InformSetupAborted"))}async function ge(e,t,n){function i(e,n){e&&ue(e),se.invokeMethodAsync("InformUninstallError",t,n)}const s=le();s.onerror=e=>{i(s,c(e))},oe.push({worker:s,id:e,monitor:null}),s.addEventListener("message",async e=>{const t=e.data;switch(t.msgtype){case"done":setTimeout(()=>{se.invokeMethodAsync("InformUninstalled",t.bookCase)},0);break;case"error":i(s,t.message)}ue(s)}),s.postMessage({bookId:e,bookName:t,params:{...n}})}function we(){ae&&ae.click()}function ke(e){if(K.hasLibrary(e.key))throw new Error(`You cannot delete a library that is in use! (library: ${e.key})`);!async function(e){function t(t,n){t&&ue(t),se.invokeMethodAsync("InformLibUnnstallError",e,n)}const n=le();n.onerror=e=>{t(n,c(e))},oe.push({worker:n,id:e.key,monitor:null}),n.addEventListener("message",async i=>{const s=i.data;switch(s.msgtype){case"done":ue(n),setTimeout(()=>{se.invokeMethodAsync("InformLibUninstallFinish",e)},0);break;case"error":t(n,s.message)}}),n.postMessage({libBrief:e,params:{}})}(e)}async function ve(e,t){se=e}class _e{id;origId;name;version;isPopup;packtype;sourceType;suiteid;filename;filesize;modified;isBroken;constructor(e){this.id=e.id,this.origId=e.origId,this.name=e.name,this.version=e.version,this.isPopup=e.isPopup,this.packtype=e.packtype||N.Classic,this.sourceType=e.sourceType,this.suiteid=e.suiteid,this.filename=e.fileinfo.fullname,this.filesize=e.fileinfo.size,this.modified=e.fileinfo.modified,this.isBroken=e.isBroken}}let je;function Le(e,t){let n=0;const i=new RegExp(`PackageId=("|')${e}`);for(const e of t)i.test(e.data)&&n++;return n}function Pe(e,t){if(!e)return"";const n=t.find(t=>t.key===e);return n?n.name:""}function xe(e,t,n){return{id:e.id,origId:e.origId,version:e.version||"0.0.0",isPopup:e.isPopup,name:e.name,packtype:e.packtype,sourceType:e.sourceType,sourceUrl:e.sourceUrl,suiteid:e.suiteid,suitename:Pe(e.suiteid,n),filename:e.fileinfo.fullname,filesize:e.fileinfo.size,modified:e.fileinfo.modified,installed:e.installed,updated:e.updated,isBroken:e.isBroken,brokeninfo:e.brokeninfo,refcount:Le(e.id,t)}}async function Ae(){return new Promise(async(e,t)=>{try{let t=await w();const n=await x(t,"shelves"),i=(await x(t,"suites")).map(e=>e);let s=t.transaction("packs","readonly").objectStore("packs");const r=[];s.openCursor().onsuccess=t=>{const s=t.target.result;if(s){const e=xe(s.value,n,i);r.push(e),s.continue()}else k(),e(r)}}catch(e){k(),t(e)}})}async function Se(e){let t=await w(),n=null;const i=await j(t,"packs",e);return i&&(n=xe(i,await x(t,"shelves"),(await x(t,"suites")).map(e=>e))),k(),n}async function Oe(){return new Promise(async(e,t)=>{try{let t=(await w()).transaction("packs","readonly").objectStore("packs");const n=[];t.openCursor().onsuccess=t=>{const i=t.target.result;if(i){const e=i.value,t=new _e(e);n.push(t),i.continue()}else k(),e(n)}}catch(e){k(),t(e)}})}async function Te(e){return!!(await _("packext",e)).overview}async function Ie(e){return(await _("packext",e)).overview||""}async function Ee(e){return(await _("packext",e)).cover||""}async function Me(e){const t=await _("packext",e);return{hasOverview:!!t.overview,cover:t.cover}}async function Re(){return new Promise(async(e,t)=>{function n(e,t){e&&e.length>0&&e.forEach(e=>{const n=B(e);i.has(n)||i.set(n,{packrefs:0,librefs:0});const s=i.get(n);t?s.packrefs=s.packrefs+1:s.librefs=s.librefs+1,i.set(n,s)})}const i=new Map;try{let t=await w();const s=[];(await P("packs")).forEach(e=>{n(e.metadata.preloadedDependencies,!0)}),t.transaction("libs","readonly").objectStore("libs").openCursor().onsuccess=t=>{const r=t.target.result;if(r){const e=r.value,t={};t.libtoken=r.key.toString(),t.image=(e.metadata.machineName,"assets/images/etc/library.svg"),t.version=`${e.metadata.majorVersion}.${e.metadata.minorVersion}.${e.metadata.patchVersion}`,t.title=e.metadata.title,t.license=e.metadata.license||"",t.author=e.metadata.author||"",t.description=e.metadata.description||"",t.fullscreen=1==e.metadata.fullscreen,t.isAddon=1==e.isAddon,t.packrefs=0,t.librefs=0,n(e.metadata.preloadedDependencies,!1),s.push(t),r.continue()}else k(),s.forEach(e=>{if(i.has(e.libtoken)){const t=i.get(e.libtoken);e.packrefs=t.packrefs,e.librefs=t.librefs}}),e(s)}}catch(e){k(),t(e)}})}async function Ue(e,t=null){const n=new RegExp(`PackageId=("|')${e}`);var i=await P("shelves");for(let e=0;e<i.length;e++){const s=i[e];if((!t||s.userId!=t)&&n.test(s.data))return!0}return!1}async function De(e){return new Promise(async(t,n)=>{try{(await w()).transaction("packs","readonly").objectStore("packs").openCursor().onsuccess=n=>{const i=n.target.result;if(i){const n=i.value;if(n.fileinfo.name===e.filename&&n.fileinfo.size===e.filesize&&n.fileinfo.modified){const e=new _e(n);return void t(e)}i.continue()}else t(null)}}catch(e){n(e)}finally{k()}})}async function Be(e){je=e,await async function(e){m=e,d=await _("_system","addons")||{},h=await a("assets/h5p-strings/default.json");let t=await a("assets/h5p-strings/en.json");f=new D(new U({client:t}).t),p=await new Promise((e,t)=>{fetch("assets/templates/h5pplayer.txt").then(n=>{!0===n.ok?e(n.text()):t(c(n))})})}(je)}function Ce(){return t}function $e(){return i}function Ve(){return n}function Ne(){return s}function Fe(){return r}export{$e as getActivePoolModule,Ce as getAppDBModule,Ve as getCryptoModule,Fe as getManagerModule,Ne as getSetupperModule};