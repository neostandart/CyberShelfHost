new Map([["css","text/css"],["js","application/x-javascript"],["json","application/json"],["docx","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],["ico","image/x-icon"],["jpeg","image/jpeg"],["jpg","image/jpeg"],["png","image/png"],["svg","image/svg+xml"],["bmp","image/bmp"],["mp3","audio/mpeg"],["mpeg","video/mpeg"],["mpg","video/mpeg"],["wma","audio/x-ms-wma"],["wav","audio/wav"]]);let e=0,t=null;function a(){return e++,new Promise((e,a)=>{if(t)e(t);else{let s=indexedDB.open("AppDB",1);s.onerror=e=>{let t=function(e){let t="";if(e instanceof Event)if(e.target instanceof IDBOpenDBRequest){const t=e.target;t.error&&(e=t.error)}else e.message&&(t=e.message);else if(e instanceof Error){const a=e;t=a.name,t.endsWith(".")||(t+="."),a.message&&(t+=" "+a.message)}else if(e instanceof Response){const s=e;t=a(`Response: ok=${s.ok}; status=${s.status}; statusText=${s.statusText}; type=${s.type}; url=${s.url}.`)}else"string"==typeof e?t=e:(e&&e.name&&(t=a(e.name)),e&&e.status&&(t=a(`status=${e.status}`)),e&&e.statusText&&(t=a(`statusText=${e.statusText}`)));return t;function a(e){return t.length>0?t+=` | ${e}`:e}}(e);a(new Error("AppDB Error: "+t))},s.onblocked=e=>{a(new Error("AppDB Failure: The application database is blocked"))},s.onsuccess=a=>{let s=a.target;t=s.result,e(t)},s.onupgradeneeded=e=>{!function(e){let t=e.target.result;e.oldVersion<3&&(function(){const e=t.objectStoreNames;for(let a=0;a<e.length;a++)t.deleteObjectStore(e[a])}(),function(){t.createObjectStore("_system"),t.createObjectStore("shared"),t.createObjectStore("users"),t.createObjectStore("shelves"),t.createObjectStore("stuffs"),t.createObjectStore("results"),t.createObjectStore("suites"),t.createObjectStore("packs"),t.createObjectStore("packcont"),t.createObjectStore("packext");const e=t.createObjectStore("wincache");e.createIndex("user_idx","userId"),e.createIndex("pack_idx","packId"),t.createObjectStore("libs"),t.createObjectStore("libfiles")}())}(e)}}})}function s(){e--,e<1&&(e=0,t&&(t.close(),t=null))}function r(e){return new Promise((t,a)=>{e.onsuccess=a=>{a.target instanceof IDBRequest?(e=a.target,t(e.result)):t(void 0)},e.onerror=e=>{a(e)}})}var n;!function(e){e[e.RegVerifying=0]="RegVerifying",e[e.RegRegistering=1]="RegRegistering",e[e.RegWaiting=2]="RegWaiting",e[e.RegUnregistering=3]="RegUnregistering",e[e.RegVerified=4]="RegVerified",e[e.RegRegistered=5]="RegRegistered",e[e.RegUnregistered=6]="RegUnregistered",e[e.RegDeclined=7]="RegDeclined",e[e.RegDiscarded=8]="RegDiscarded",e[e.HttpFailure=9]="HttpFailure",e[e.HttpError=10]="HttpError"}(n||(n={}));const i=self;var o=!1;function c(e){return e instanceof Error?e.message:"string"==typeof e?e:"Unknown error"}function l(e){return new Promise(t=>setTimeout(t,e))}async function p(e){const t=await i.clients.matchAll();for(const a of t)a.postMessage(e)}class u extends Error{attempts;constructor(e){super(`The poll was canceled after ${e} attempts`),this.attempts=e,this.name="PollingCancelledError"}}class g{_url;_options;_requestOptions;_attempts=0;_isCancelled=!1;constructor(e,t={},a){this._url=e,this._options={interval:5e3,...t},this._requestOptions={headers:{"Content-Type":"application/json",Accept:"application/json",...a.headers},...a}}async makeRequest(){const e=await fetch(this._url,this._requestOptions);if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);return await e.json()??null}cancel(){this._isCancelled=!0}getAttemptCount(){return this._attempts}async poll(){for(;!this._isCancelled;){this._attempts++,this._options.onAttempt&&this._options.onAttempt(this._attempts);try{var e=await this.makeRequest();if(this._options.validateResponse&&(null===e||this._options.validateResponse(e)||(e=null)),null!==e)return e}catch(e){const t=e instanceof Error?e:new Error(String(e));console.error(`Error on attempt ${this._attempts}:`,t.message),this._options.onError&&this._options.onError(t)}if(this._isCancelled)break;await l(this._options.interval)}throw new u(this._attempts)}}async function d(){return await async function(e,t){let n;try{let s=(await a()).transaction(e,"readonly").objectStore(e);n=await r(s.get(t))}finally{return s(),n}}("_system","credential")}async function y(e){return async function(e,t,n){try{let s=(await a()).transaction(e,"readwrite").objectStore(e);await r(s.put(t,n))}finally{s()}}("_system",e,"credential")}async function f(){return async function(e){try{(await a()).transaction(e,"readwrite").objectStore(e).delete("credential")}finally{s()}}("_system")}async function h(e,t){const a=new g(e,{interval:7e3,validateResponse:e=>!e.email&&!e.cryptoKeyValue||!!e.email&&!!e.cryptoKeyValue},{method:"GET",mode:"cors",headers:{Authorization:t.apiKey,Accept:"application/json","Content-Type":"application/json"}});let s;const r=await a.poll();if("string"==typeof r.cryptoKeyValue){if(t.anchor!==r.email)throw await f(),new Error(`Inconsistent user's details: "${t.anchor}" & "${r.email}" is not equal!`);t.cryptoKey=r.cryptoKeyValue,await y(t),s={type:n.RegRegistered,credential:t,unregAgentInfo:r.deletedApiKeyInfo}}else await f(),s={type:n.RegDeclined,message:null};return s}i.addEventListener("install",e=>{i.skipWaiting()}),i.addEventListener("activate",e=>{e.waitUntil(i.clients.claim())}),i.addEventListener("fetch",e=>{}),i.addEventListener("message",async e=>{if(!o){const t=e.data;switch(t.type){case"VERIFICATION":o=!0,p({type:n.RegVerifying}),await async function(e){var t;try{const a=await d();switch(!0){case"object"==typeof a&&!!a?.cryptoKey:const s={method:"GET",mode:"cors",headers:{Authorization:a.apiKey}},r=await fetch(e.verificationRequest,s);if(r.ok)t={type:n.RegVerified,credential:a};else switch(r.status){case 401:case 403:t={type:n.RegDiscarded,message:null},await f();break;default:t={type:n.HttpError,credential:await d(),message:`Server error. Response status: ${r.status}.`}}break;case"object"==typeof a:p({type:n.RegWaiting,anchor:a.anchor}),t=await h(e.cryptoKeyRequest,a);break;default:a&&await f(),t={type:n.RegVerified,credential:null}}}catch(e){t={type:n.HttpError,credential:await d(),message:c(e)}}p(t)}(t),o=!1;break;case"REGISTRATION":o=!0,p({type:n.RegRegistering,anchor:t.anchor}),await async function(e){const t={email:e.anchor,apiKeyValue:void 0};try{const a=await fetch(e.apiKeyRequest,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});switch(a.status){case 200:{const t=await a.json();if(!function(e){if("object"!=typeof e||null===e)return!1;const t=Object.hasOwn(e,"email")&&"string"==typeof e.email,a=Object.hasOwn(e,"apiKeyValue")&&"string"==typeof e.apiKeyValue;return t&&a}(t))throw new Error(`Inconsistent response data! (request: ${e.apiKeyRequest})`);let s={anchor:t.email,apiKey:t.apiKeyValue,cryptoKey:void 0};await y(s),p({type:n.RegWaiting,anchor:s.anchor}),p(await h(e.cryptoKeyRequest,s))}break;case 403:p({type:n.HttpFailure,status:a.status,credential:await d()});break;default:throw new Error(`HTTP error! status: ${a.status}`)}}catch(e){p({type:n.HttpError,credential:await d(),message:c(e)})}}(t),o=!1;break;case"UNREGISTRATION":o=!0,p({type:n.RegUnregistering,anchor:t.anchor}),await async function(e){try{const t=await fetch(e.unregRequest,{method:"DELETE",headers:{Authorization:e.apiKey}});switch(t.status){case 200:await f(),p({type:n.RegUnregistered,anchor:e.anchor});break;case 401:case 403:await f(),p({type:n.HttpFailure,status:t.status,credential:await d()});break;default:throw new Error(`HTTP error! status: ${t.status}`)}}catch(e){p({type:n.HttpError,credential:await d(),message:c(e)})}}(t),o=!1}}});